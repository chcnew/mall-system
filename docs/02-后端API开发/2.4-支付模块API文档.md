# 2.4 支付模块 API 文档

## 一、概述

本文档描述微信支付集成相关 API 接口，包括支付发起、回调处理、状态查询。

**基础 URL**: `http://localhost:8000/api/v1`

---

## 二、支付流程

```
用户下单 → 调用预下单 → 返回支付参数 → 调起微信支付 → 支付回调 → 更新订单状态
```

---

## 三、支付接口

### 3.1 发起支付

创建支付订单，返回微信支付所需的参数。

**接口**: `POST /api/v1/payment/prepay`

**认证**: 需要登录（Token）

**请求参数**:

```json
{
  "order_no": "202401201234560001"
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| order_no | string | 是 | 订单号 |

**响应示例**:

```json
{
  "code": 0,
  "message": "支付参数生成成功",
  "data": {
    "timeStamp": "1705726500",
    "nonceStr": "abc123...",
    "package": "prepay_id=wx20240120100500123456789",
    "signType": "RSA",
    "paySign": "xxx..."
  }
}
```

---

### 3.2 支付回调通知

接收微信支付服务器的异步回调通知。

**接口**: `POST /api/v1/payment/notify`

**认证**: 无需登录（微信支付服务器回调）

**请求方式**: application/json

**请求体示例**:

```json
{
  "id": "EV-2018022511223320873",
  "create_time": "2018-02-25T12:22:33+08:00",
  "resource_type": "encrypt-resource",
  "event_type": "TRANSACTION.SUCCESS",
  "resource": {
    "algorithm": "AEAD_AES_256_GCM",
    "ciphertext": "xxx...",
    "nonce": "xxx...",
    "associated_data": "xxx..."
  }
}
```

**响应**:

```json
{
  "code": "SUCCESS",
  "message": "成功"
}
```

---

### 3.3 查询支付状态

查询订单的支付状态。

**接口**: `GET /api/v1/payment/status/{order_no}`

**认证**: 需要登录（Token）

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| order_no | string | 订单号 |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "order_no": "202401201234560001",
    "order_id": 1001,
    "status": 1,
    "is_paid": true,
    "pay_time": "2024-01-20 10:05:00",
    "pay_type": 1,
    "transaction_id": "wx20240120100500123456789",
    "pay_amount": 297.00
  }
}
```

| 字段名 | 类型 | 说明 |
|--------|------|------|
| status | integer | 订单状态：0待付款 1待发货 |
| is_paid | boolean | 是否已支付 |
| pay_time | string | 支付时间 |
| pay_type | integer | 支付方式：1微信支付 |
| transaction_id | string | 微信支付流水号 |

---

## 四、支付回调处理逻辑

### 4.1 验签
- 验证微信支付签名
- 验证时间戳（5分钟内）

### 4.2 解密数据
- 使用 API v3 密钥解密回调数据
- 提取订单号、交易号、支付金额

### 4.3 更新订单
- 验证订单状态（只能处理待付款订单）
- 更新订单状态为待发货
- 记录支付时间、交易流水号
- 扣减库存（从 Redis 锁定到 MySQL 实扣）
- 标记优惠券已使用

### 4.4 释放订单锁
- 删除 Redis 订单锁
- 取消 Celery 超时取消任务

---

## 五、防重复支付

### 5.1 订单锁
```python
# 创建支付时设置锁
redis.setex(f"order:lock:{order_no}", 300, "1")  # 5分钟

# 处理回调时检查锁
if not redis.exists(f"order:lock:{order_no}"):
    return {"code": "FAIL", "message": "订单已处理"}
```

### 5.2 幂等性
- 同一订单号多次回调，只处理第一次
- 订单状态不为待付款时，直接返回成功

---

## 六、错误码说明

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 404 | 订单不存在 |
| 403 | 订单状态不允许支付 |
| 500 | 支付失败 |

---

## 七、调试示例

### 使用 cURL

```bash
# 发起支付
curl -X POST "http://localhost:8000/api/v1/payment/prepay" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "order_no": "202401201234560001"
  }'

# 查询支付状态
curl -X GET "http://localhost:8000/api/v1/payment/status/202401201234560001" \
  -H "Authorization: Bearer <token>"
```

---

## 八、前端对接建议

### 发起支付
```javascript
Page({
  onLoad(options) {
    this.orderNo = options.order_no;
    this.payAmount = options.amount;
    this.createPayment();
  },

  createPayment() {
    wx.request({
      url: 'http://localhost:8000/api/v1/payment/prepay',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      data: {
        order_no: this.orderNo
      },
      success: (res) => {
        const payParams = res.data.data;
        this.wxPay(payParams);
      }
    });
  },

  wxPay(payParams) {
    wx.requestPayment({
      timeStamp: payParams.timeStamp,
      nonceStr: payParams.nonceStr,
      package: payParams.package,
      signType: payParams.signType,
      paySign: payParams.paySign,
      success: (res) => {
        wx.showToast({ title: '支付成功' });
        // 跳转到订单详情
        setTimeout(() => {
          wx.redirectTo({
            url: `/pages/order/detail/index?order_no=${this.orderNo}`
          });
        }, 1000);
      },
      fail: (err) => {
        if (err.errMsg.includes('cancel')) {
          wx.showToast({ title: '已取消支付', icon: 'none' });
        } else {
          wx.showToast({ title: '支付失败', icon: 'none' });
          // 查询支付状态（可能是支付成功但回调未到达）
          this.checkPaymentStatus();
        }
      }
    });
  },

  checkPaymentStatus() {
    wx.showLoading({ title: '查询支付状态...' });

    wx.request({
      url: `http://localhost:8000/api/v1/payment/status/${this.orderNo}`,
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      success: (res) => {
        wx.hideLoading();
        const data = res.data.data;
        if (data.is_paid) {
          wx.showToast({ title: '支付成功' });
          setTimeout(() => {
            wx.redirectTo({
              url: `/pages/order/detail/index?order_no=${this.orderNo}`
            });
          }, 1000);
        } else {
          wx.showToast({ title: '支付未完成', icon: 'none' });
        }
      }
    });
  }
});
```

### 轮询支付状态
```javascript
// 支付页面轮询支付状态（每3秒查询一次，最多10次）
Page({
  data: {
    pollingCount: 0
  },

  startPolling() {
    this.pollingTimer = setInterval(() => {
      this.checkPaymentStatus();
    }, 3000);
  },

  stopPolling() {
    if (this.pollingTimer) {
      clearInterval(this.pollingTimer);
      this.pollingTimer = null;
    }
  },

  checkPaymentStatus() {
    if (this.data.pollingCount >= 10) {
      this.stopPolling();
      return;
    }

    this.setData({ pollingCount: this.data.pollingCount + 1 });

    wx.request({
      url: `http://localhost:8000/api/v1/payment/status/${this.orderNo}`,
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      success: (res) => {
        const data = res.data.data;
        if (data.is_paid) {
          this.stopPolling();
          wx.showToast({ title: '支付成功' });
          wx.redirectTo({
            url: `/pages/order/detail/index?order_no=${this.orderNo}`
          });
        }
      }
    });
  },

  onLoad(options) {
    this.orderNo = options.order_no;
    this.startPolling();
  },

  onUnload() {
    this.stopPolling();
  }
});
```

---

## 九、沙箱环境测试

### 9.1 沙箱环境配置
微信支付提供沙箱环境用于测试：
- 沙箱商户号：在商户平台获取
- 沙箱密钥：不同于正式环境

### 9.2 测试步骤
1. 在商户平台开通沙箱环境
2. 修改后端配置，使用沙箱商户号和密钥
3. 使用沙箱环境下单和支付
4. 验证支付回调处理逻辑

---

## 十、生产环境注意事项

### 10.1 安全配置
- 使用正式商户号和 API v3 密钥
- 配置正确的证书路径
- 支付回调地址必须使用 HTTPS

### 10.2 证书管理
- 下载商户 API 证书
- 存储证书到服务器安全位置
- 配置正确的证书路径

### 10.3 回调地址
- 支付回调地址必须是公网可访问的 HTTPS 地址
- 在商户平台配置正确的回调地址
- 域名需要 ICP 备案

### 10.4 日志记录
- 记录所有支付回调日志
- 记录验签结果
- 记录订单更新结果

---

## 十一、常见问题

### Q: 支付成功但订单状态未更新？
A:
1. 检查回调地址是否配置正确
2. 查看后端日志，确认回调是否到达
3. 手动调用查询支付状态接口同步

### Q: 支付回调验签失败？
A:
1. 检查 API v3 密钥是否正确
2. 检查证书是否正确配置
3. 检查回调数据是否被篡改

### Q: 如何处理重复支付？
A:
1. 使用 Redis 订单锁防止重复处理
2. 检查订单状态，已支付订单直接返回成功
3. 记录重复支付日志

### Q: 支付超时如何处理？
A:
1. 使用 Celery 延迟任务，30分钟后自动取消订单
2. 取消订单时释放库存
3. 用户支付成功后手动取消超时任务

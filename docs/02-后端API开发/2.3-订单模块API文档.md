# 2.3 订单模块 API 文档

## 一、概述

本文档描述订单创建、查询、状态管理相关 API 接口。

**基础 URL**: `http://localhost:8000/api/v1`

---

## 二、订单模块

### 2.1 创建订单

创建新订单，自动锁定库存。

**接口**: `POST /api/v1/orders`

**认证**: 需要登录（Token）

**请求参数**:

```json
{
  "address_id": 1,
  "items": [
    {
      "product_id": 1,
      "sku_id": 1,
      "quantity": 2
    },
    {
      "product_id": 2,
      "sku_id": 3,
      "quantity": 1
    }
  ],
  "coupon_id": 10,
  "remark": "请尽快发货"
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| address_id | integer | 是 | 收货地址 ID |
| items | array | 是 | 商品列表 |
| items[].product_id | integer | 是 | 商品 ID |
| items[].sku_id | integer | 是 | SKU ID |
| items[].quantity | integer | 是 | 购买数量 |
| coupon_id | integer | 否 | 优惠券 ID |
| remark | string | 否 | 订单备注 |

**响应示例**:

```json
{
  "code": 0,
  "message": "订单创建成功",
  "data": {
    "order_no": "202401201234560001",
    "order_id": 1001,
    "total_amount": 297.00,
    "freight_amount": 0.00,
    "discount_amount": 0.00,
    "pay_amount": 297.00,
    "expire_time": "2024-01-20 11:00:00"
  }
}
```

---

### 2.2 获取订单列表

获取当前用户的订单列表，支持筛选和分页。

**接口**: `GET /api/v1/orders`

**认证**: 需要登录（Token）

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | integer | 否 | 页码，默认 1 |
| size | integer | 否 | 每页数量，默认 20 |
| status | integer | 否 | 订单状态：0待付款 1待发货 2待收货 3已完成 4已取消 5已退款 |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "total": 5,
    "page": 1,
    "size": 20,
    "pages": 1,
    "items": [
      {
        "id": 1001,
        "order_no": "202401201234560001",
        "status": 0,
        "total_amount": 297.00,
        "pay_amount": 297.00,
        "created_at": "2024-01-20 10:00:00",
        "expire_time": "2024-01-20 11:00:00",
        "items": [
          {
            "product_id": 1,
            "product_name": "男士T恤",
            "product_image": "https://...",
            "specs": "白色/L",
            "price": 99.00,
            "quantity": 2
          },
          {
            "product_id": 2,
            "product_name": "女士连衣裙",
            "product_image": "https://...",
            "specs": "红色/M",
            "price": 99.00,
            "quantity": 1
          }
        ],
        "address": {
          "name": "张三",
          "phone": "13800138000",
          "province": "广东省",
          "city": "深圳市",
          "district": "南山区",
          "detail": "科技园123号"
        }
      }
    ]
  }
}
```

---

### 2.3 获取订单详情

获取指定订单的详细信息。

**接口**: `GET /api/v1/orders/{id}`

**认证**: 需要登录（Token）

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 订单 ID |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "id": 1001,
    "order_no": "202401201234560001",
    "user_id": 1,
    "status": 1,
    "total_amount": 297.00,
    "freight_amount": 0.00,
    "discount_amount": 0.00,
    "pay_amount": 297.00,
    "pay_time": "2024-01-20 10:05:00",
    "pay_type": 1,
    "transaction_id": "wx20240120100500123456789",
    "ship_time": null,
    "receive_time": null,
    "address": {
      "name": "张三",
      "phone": "13800138000",
      "province": "广东省",
      "city": "深圳市",
      "district": "南山区",
      "detail": "科技园123号"
    },
    "remark": "请尽快发货",
    "created_at": "2024-01-20 10:00:00",
    "updated_at": "2024-01-20 10:05:00",
    "items": [
      {
        "id": 2001,
        "product_id": 1,
        "product_name": "男士T恤",
        "product_image": "https://...",
        "specs": "白色/L",
        "price": 99.00,
        "quantity": 2
      }
    ],
    "logistics": {
      "company": "顺丰快递",
      "tracking_no": "SF1234567890",
      "traces": [
        {
          "time": "2024-01-20 10:00:00",
          "status": "已揽收",
          "location": "深圳市"
        },
        {
          "time": "2024-01-21 08:00:00",
          "status": "运输中",
          "location": "广州市"
        }
      ]
    }
  }
}
```

---

### 2.4 取消订单

取消未支付的订单，自动释放库存。

**接口**: `POST /api/v1/orders/{id}/cancel`

**认证**: 需要登录（Token）

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 订单 ID |

**响应示例**:

```json
{
  "code": 0,
  "message": "订单已取消"
}
```

---

### 2.5 确认收货

确认收货，订单状态变更为已完成。

**接口**: `POST /api/v1/orders/{id}/confirm`

**认证**: 需要登录（Token）

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 订单 ID |

**响应示例**:

```json
{
  "code": 0,
  "message": "确认收货成功"
}
```

---

### 2.6 删除订单

删除已完成或已取消的订单。

**接口**: `DELETE /api/v1/orders/{id}`

**认证**: 需要登录（Token）

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 订单 ID |

**响应示例**:

```json
{
  "code": 0,
  "message": "订单已删除"
}
```

---

## 三、订单状态说明

| 状态值 | 状态 | 说明 | 允许操作 |
|--------|------|------|---------|
| 0 | 待付款 | 订单已创建，未支付 | 取消订单、支付 |
| 1 | 待发货 | 已支付，待商家发货 | 确认收货 |
| 2 | 待收货 | 已发货，待用户确认 | 确认收货 |
| 3 | 已完成 | 用户已确认收货 | 删除订单 |
| 4 | 已取消 | 订单已取消 | 删除订单 |
| 5 | 已退款 | 已退款 | 删除订单 |

---

## 四、库存锁定机制

### 4.1 锁定库存
- 创建订单时，使用 Redis 锁定库存
- 锁定时间：30 分钟
- 库存键：`stock:lock:{sku_id}`

### 4.2 扣减库存
- 支付成功后，扣减 MySQL 实际库存
- 释放 Redis 锁

### 4.3 释放库存
- 订单取消或超时，释放 Redis 锁
- 库存回滚

---

## 五、订单超时取消

### 5.1 Celery 延迟任务
订单创建后 30 分钟未支付自动取消。

### 5.2 任务配置
```python
@celery_app.task
def cancel_unpaid_order(order_no: str):
    # 取消订单
    order = db.query(Order).filter(Order.order_no == order_no).first()
    if order and order.status == 0:
        order.status = 4  # 已取消
        # 释放库存
        for item in order.items:
            release_stock(item.sku_id, item.quantity)
        db.commit()
```

---

## 六、错误码说明

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 404 | 订单不存在 |
| 403 | 订单状态不允许此操作 |
| 500 | 库存不足 |

---

## 七、调试示例

### 使用 cURL

```bash
# 创建订单
curl -X POST "http://localhost:8000/api/v1/orders" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "address_id": 1,
    "items": [
      {
        "product_id": 1,
        "sku_id": 1,
        "quantity": 2
      }
    ]
  }'

# 获取订单列表
curl -X GET "http://localhost:8000/api/v1/orders?status=0&page=1" \
  -H "Authorization: Bearer <token>"

# 获取订单详情
curl -X GET "http://localhost:8000/api/v1/orders/1001" \
  -H "Authorization: Bearer <token>"

# 取消订单
curl -X POST "http://localhost:8000/api/v1/orders/1001/cancel" \
  -H "Authorization: Bearer <token>"

# 确认收货
curl -X POST "http://localhost:8000/api/v1/orders/1001/confirm" \
  -H "Authorization: Bearer <token>"
```

---

## 八、前端对接建议

### 创建订单
```javascript
Page({
  createOrder() {
    wx.request({
      url: 'http://localhost:8000/api/v1/orders',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      data: {
        address_id: this.data.addressId,
        items: this.data.selectedItems,
        coupon_id: this.data.couponId,
        remark: this.data.remark
      },
      success: (res) => {
        const order = res.data.data;
        // 跳转到支付页面
        wx.navigateTo({
          url: `/pages/payment/index?order_no=${order.order_no}&amount=${order.pay_amount}`
        });
      }
    });
  }
});
```

### 订单列表（Tab 切换）
```javascript
Page({
  data: {
    activeTab: 0,
    tabs: ['全部', '待付款', '待发货', '待收货', '已完成'],
    orders: []
  },

  onLoad() {
    this.loadOrders();
  },

  switchTab(e) {
    const index = e.currentTarget.dataset.index;
    this.setData({ activeTab: index });
    this.loadOrders();
  },

  loadOrders() {
    // 状态映射：全部=null, 待付款=0, 待发货=1, 待收货=2, 已完成=3
    const status = this.data.activeTab === 0 ? null : this.data.activeTab - 1;

    wx.request({
      url: 'http://localhost:8000/api/v1/orders',
      data: { status },
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      success: (res) => {
        this.setData({ orders: res.data.data.items });
      }
    });
  }
});
```

### 订单详情
```javascript
Page({
  onLoad(options) {
    const orderId = options.id;
    this.loadOrderDetail(orderId);
  },

  loadOrderDetail(id) {
    wx.request({
      url: `http://localhost:8000/api/v1/orders/${id}`,
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      success: (res) => {
        this.setData({ order: res.data.data });
      }
    });
  },

  // 取消订单
  cancelOrder() {
    wx.showModal({
      title: '确认取消订单？',
      success: (res) => {
        if (res.confirm) {
          wx.request({
            url: `http://localhost:8000/api/v1/orders/${this.data.order.id}/cancel`,
            method: 'POST',
            header: {
              'Authorization': `Bearer ${wx.getStorageSync('token')}`
            },
            success: (res) => {
              wx.showToast({ title: '订单已取消' });
              this.loadOrderDetail(this.data.order.id);
            }
          });
        }
      }
    });
  },

  // 确认收货
  confirmOrder() {
    wx.showModal({
      title: '确认已收到商品？',
      success: (res) => {
        if (res.confirm) {
          wx.request({
            url: `http://localhost:8000/api/v1/orders/${this.data.order.id}/confirm`,
            method: 'POST',
            header: {
              'Authorization': `Bearer ${wx.getStorageSync('token')}`
            },
            success: (res) => {
              wx.showToast({ title: '确认收货成功' });
              this.loadOrderDetail(this.data.order.id);
            }
          });
        }
      }
    });
  }
});
```

### 物流跟踪
```javascript
// 在订单详情页显示物流信息
<view wx:if="{{order.logistics}}">
  <view class="logistics">
    <text>物流公司：{{order.logistics.company}}</text>
    <text>物流单号：{{order.logistics.tracking_no}}</text>
  </view>
  <view class="traces">
    <view wx:for="{{order.logistics.traces}}" wx:key="index" class="trace-item">
      <text class="time">{{item.time}}</text>
      <text class="status">{{item.status}}</text>
      <text class="location">{{item.location}}</text>
    </view>
  </view>
</view>
```

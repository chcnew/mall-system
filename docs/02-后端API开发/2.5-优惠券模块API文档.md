# 2.5 优惠券模块 API 文档

## 一、概述

本文档描述优惠券相关 API 接口，包括优惠券模板、领取、使用等。

**基础 URL**: `http://localhost:8000/api/v1`

---

## 二、优惠券接口

### 2.1 获取可领优惠券列表

获取当前用户可以领取的优惠券列表。

**接口**: `GET /api/v1/coupons`

**认证**: 需要登录（Token）

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | integer | 否 | 页码，默认 1 |
| size | integer | 否 | 每页数量，默认 20 |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "total": 5,
    "page": 1,
    "size": 20,
    "pages": 1,
    "items": [
      {
        "id": 1,
        "name": "满100减20优惠券",
        "type": 1,
        "value": 20.00,
        "min_amount": 100.00,
        "total_count": 1000,
        "remain_count": 800,
        "per_limit": 1,
        "start_time": "2024-01-01 00:00:00",
        "end_time": "2024-12-31 23:59:59",
        "status": 1,
        "is_received": false
      },
      {
        "id": 2,
        "name": "全场9折券",
        "type": 2,
        "value": 0.9,
        "min_amount": 0.00,
        "total_count": 500,
        "remain_count": 300,
        "per_limit": 1,
        "start_time": "2024-01-01 00:00:00",
        "end_time": "2024-06-30 23:59:59",
        "status": 1,
        "is_received": true
      }
    ]
  }
}
```

| 字段名 | 类型 | 说明 |
|--------|------|------|
| type | integer | 优惠券类型：1满减 2折扣 3无门槛 |
| value | decimal | 优惠值（满减金额/折扣值） |
| min_amount | decimal | 最低消费金额 |
| per_limit | integer | 每人限领数量 |
| is_received | boolean | 是否已领取 |

---

### 2.2 领取优惠券

领取指定的优惠券。

**接口**: `POST /api/v1/coupons/{id}/receive`

**认证**: 需要登录（Token）

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 优惠券模板 ID |

**响应示例**:

```json
{
  "code": 0,
  "message": "领取成功",
  "data": {
    "id": 1001,
    "user_id": 1,
    "coupon_id": 1,
    "status": 0,
    "expire_time": "2024-12-31 23:59:59",
    "created_at": "2024-01-20 10:00:00"
  }
}
```

---

### 2.3 获取我的优惠券

获取当前用户的所有优惠券。

**接口**: `GET /api/v1/user/coupons`

**认证**: 需要登录（Token）

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| status | integer | 否 | 状态：0未使用 1已使用 2已过期，默认全部 |
| page | integer | 否 | 页码，默认 1 |
| size | integer | 否 | 每页数量，默认 20 |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "total": 3,
    "page": 1,
    "size": 20,
    "pages": 1,
    "items": [
      {
        "id": 1001,
        "coupon_id": 1,
        "name": "满100减20优惠券",
        "type": 1,
        "value": 20.00,
        "min_amount": 100.00,
        "status": 0,
        "expire_time": "2024-12-31 23:59:59",
        "created_at": "2024-01-20 10:00:00"
      },
      {
        "id": 1002,
        "coupon_id": 2,
        "name": "全场9折券",
        "type": 2,
        "value": 0.9,
        "min_amount": 0.00,
        "status": 0,
        "expire_time": "2024-06-30 23:59:59",
        "created_at": "2024-01-15 10:00:00"
      }
    ]
  }
}
```

---

### 2.4 计算优惠金额

计算使用指定优惠券后的优惠金额。

**接口**: `POST /api/v1/coupons/calculate`

**认证**: 需要登录（Token）

**请求参数**:

```json
{
  "coupon_id": 1,
  "total_amount": 297.00
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| coupon_id | integer | 是 | 优惠券 ID |
| total_amount | decimal | 是 | 订单总金额 |

**响应示例**:

```json
{
  "code": 0,
  "message": "计算成功",
  "data": {
    "can_use": true,
    "discount_amount": 20.00,
    "final_amount": 277.00
  }
}
```

| 字段名 | 类型 | 说明 |
|--------|------|------|
| can_use | boolean | 是否可以使用 |
| discount_amount | decimal | 优惠金额 |
| final_amount | decimal | 最终金额 |

---

## 三、优惠券类型说明

| 类型 | 值 | 说明 | 计算方式 |
|------|-----|------|---------|
| 满减 | 1 | 满足金额减免固定金额 | 实付 = 订单金额 - 优惠值（订单金额 ≥ 最低消费） |
| 折扣 | 2 | 折扣优惠 | 实付 = 订单金额 × 优惠值（如 0.9 表示9折） |
| 无门槛 | 3 | 直接减免 | 实付 = 订单金额 - 优惠值 |

---

## 四、优惠券验证规则

### 4.1 领取验证
- 优惠券状态为启用
- 剩余数量 > 0
- 用户未超过每人限领数量
- 当前时间在有效期范围内

### 4.2 使用验证
- 优惠券状态为未使用
- 优惠券未过期
- 订单金额 ≥ 最低消费金额（如适用）

---

## 五、Redis 缓存

### 5.1 优惠券剩余数量
- **缓存键**: `coupon:remain:{coupon_id}`
- **数据类型**: String
- **过期时间**: 持久化
- **更新策略**: 领取/退还时更新

### 5.2 可领优惠券列表
- **缓存键**: `coupon:available:list`
- **数据类型**: String (JSON)
- **过期时间**: 10 分钟
- **更新策略**: 优惠券模板修改时清除

---

## 六、错误码说明

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 优惠券已领完/超过限领数量/已过期 |
| 404 | 优惠券不存在 |

---

## 七、调试示例

### 使用 cURL

```bash
# 获取可领优惠券列表
curl -X GET "http://localhost:8000/api/v1/coupons" \
  -H "Authorization: Bearer <token>"

# 领取优惠券
curl -X POST "http://localhost:8000/api/v1/coupons/1/receive" \
  -H "Authorization: Bearer <token>"

# 获取我的优惠券
curl -X GET "http://localhost:8000/api/v1/user/coupons?status=0" \
  -H "Authorization: Bearer <token>"

# 计算优惠金额
curl -X POST "http://localhost:8000/api/v1/coupons/calculate" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "coupon_id": 1,
    "total_amount": 297.00
  }'
```

---

## 八、前端对接建议

### 优惠券列表
```javascript
Page({
  onLoad() {
    this.loadCoupons();
  },

  loadCoupons() {
    wx.request({
      url: 'http://localhost:8000/api/v1/coupons',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      success: (res) => {
        this.setData({ coupons: res.data.data.items });
      }
    });
  },

  receiveCoupon(e) {
    const couponId = e.currentTarget.dataset.id;
    wx.request({
      url: `http://localhost:8000/api/v1/coupons/${couponId}/receive`,
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      success: (res) => {
        wx.showToast({ title: '领取成功' });
        this.loadCoupons();
      }
    });
  }
});
```

### 我的优惠券（Tab 切换）
```javascript
Page({
  data: {
    activeTab: 0,
    tabs: ['未使用', '已使用', '已过期'],
    coupons: []
  },

  onLoad() {
    this.loadMyCoupons();
  },

  switchTab(e) {
    const index = e.currentTarget.dataset.index;
    this.setData({ activeTab: index });
    this.loadMyCoupons();
  },

  loadMyCoupons() {
    // 状态映射：未使用=0, 已使用=1, 已过期=2
    const status = this.data.activeTab;

    wx.request({
      url: 'http://localhost:8000/api/v1/user/coupons',
      data: { status },
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      success: (res) => {
        this.setData({ coupons: res.data.data.items });
      }
    });
  }
});
```

### 订单确认页选择优惠券
```javascript
Page({
  data: {
    coupons: [],
    selectedCoupon: null,
    totalAmount: 0
  },

  onLoad() {
    this.loadAvailableCoupons();
  },

  loadAvailableCoupons() {
    wx.request({
      url: 'http://localhost:8000/api/v1/user/coupons',
      data: { status: 0 },  // 未使用
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      success: (res) => {
        this.setData({ coupons: res.data.data.items });
      }
    });
  },

  selectCoupon(e) {
    const coupon = e.currentTarget.dataset.coupon;
    if (this.data.selectedCoupon && this.data.selectedCoupon.id === coupon.id) {
      // 取消选择
      this.setData({ selectedCoupon: null });
    } else {
      // 选择优惠券
      this.calculateDiscount(coupon);
    }
  },

  calculateDiscount(coupon) {
    wx.request({
      url: 'http://localhost:8000/api/v1/coupons/calculate',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      data: {
        coupon_id: coupon.id,
        total_amount: this.data.totalAmount
      },
      success: (res) => {
        const data = res.data.data;
        if (data.can_use) {
          this.setData({
            selectedCoupon: coupon,
            discountAmount: data.discount_amount,
            finalAmount: data.final_amount
          });
        } else {
          wx.showToast({ title: '优惠券不可用', icon: 'none' });
        }
      }
    });
  }
});
```

### 创建订单时使用优惠券
```javascript
createOrder() {
  wx.request({
    url: 'http://localhost:8000/api/v1/orders',
    method: 'POST',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('token')}`
    },
    data: {
      address_id: this.data.addressId,
      items: this.data.selectedItems,
      coupon_id: this.data.selectedCoupon ? this.data.selectedCoupon.id : null,
      remark: this.data.remark
    },
    success: (res) => {
      const order = res.data.data;
      wx.navigateTo({
        url: `/pages/payment/index?order_no=${order.order_no}&amount=${order.pay_amount}`
      });
    }
  });
}
```

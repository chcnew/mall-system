# 2.1 认证与用户 API 文档

## 一、概述

本文档描述微信商城小程序的认证与用户管理相关 API 接口。

**基础 URL**: `http://localhost:8000/api/v1`

---

## 二、认证模块

### 2.1 微信登录

用户使用微信授权登录。

**接口**: `POST /api/v1/auth/login`

**请求参数**:

```json
{
  "code": "071ABCdefGHIjklMNOpqrSTUvwxYZ"
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | string | 是 | 微信登录 code |

**响应示例**:

```json
{
  "code": 0,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "openid": "oABC123...",
    "session_key": "xxx...",
    "is_new_user": false,
    "user": {
      "id": 1,
      "openid": "oABC123...",
      "nickname": "微信用户",
      "avatar": "https://...",
      "phone": null,
      "balance": 0.00,
      "points": 0,
      "status": 1
    }
  }
}
```

| 字段名 | 类型 | 说明 |
|--------|------|------|
| token | string | JWT Token，7天有效 |
| openid | string | 微信 openid |
| session_key | string | 会话密钥（前端保存） |
| is_new_user | boolean | 是否新用户 |
| user | object | 用户信息 |

**错误响应**:

```json
{
  "code": 400,
  "message": "code 无效"
}
```

---

### 2.2 获取手机号

获取用户授权的手机号。

**接口**: `POST /api/v1/auth/phone`

**认证**: 需要登录（Token）

**请求参数**:

```json
{
  "encryptedData": "xxx...",
  "iv": "xxx..."
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| encryptedData | string | 是 | 加密数据 |
| iv | string | 是 | 加密算法初始向量 |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "phoneNumber": "13800138000",
    "purePhoneNumber": "13800138000",
    "countryCode": "86"
  }
}
```

---

## 三、用户信息模块

### 3.1 获取当前用户信息

获取当前登录用户的详细信息。

**接口**: `GET /api/v1/user/profile`

**认证**: 需要登录（Token）

**请求头**:
```
Authorization: Bearer <token>
```

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "id": 1,
    "openid": "oABC123...",
    "unionid": null,
    "nickname": "微信用户",
    "avatar": "https://thirdwx.qlogo.cn/...",
    "phone": "13800138000",
    "gender": 0,
    "balance": 100.50,
    "points": 500,
    "status": 1,
    "created_at": "2024-01-01 10:00:00"
  }
}
```

---

### 3.2 更新用户信息

更新当前用户的基本信息。

**接口**: `PUT /api/v1/user/profile`

**认证**: 需要登录（Token）

**请求参数**:

```json
{
  "nickname": "张三",
  "avatar": "https://...",
  "gender": 1
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| nickname | string | 否 | 昵称 |
| avatar | string | 否 | 头像 URL |
| gender | integer | 否 | 性别：0未知 1男 2女 |

**响应示例**:

```json
{
  "code": 0,
  "message": "更新成功",
  "data": {
    "id": 1,
    "nickname": "张三",
    "avatar": "https://...",
    "gender": 1
  }
}
```

---

## 四、收货地址模块

### 4.1 获取地址列表

获取当前用户的所有收货地址。

**接口**: `GET /api/v1/user/addresses`

**认证**: 需要登录（Token）

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": [
    {
      "id": 1,
      "user_id": 1,
      "name": "张三",
      "phone": "13800138000",
      "province": "广东省",
      "city": "深圳市",
      "district": "南山区",
      "detail": "科技园123号",
      "is_default": 1,
      "created_at": "2024-01-01 10:00:00"
    },
    {
      "id": 2,
      "user_id": 1,
      "name": "李四",
      "phone": "13900139000",
      "province": "广东省",
      "city": "深圳市",
      "district": "福田区",
      "detail": "华强北456号",
      "is_default": 0,
      "created_at": "2024-01-02 11:00:00"
    }
  ]
}
```

---

### 4.2 创建收货地址

创建新的收货地址。

**接口**: `POST /api/v1/user/addresses`

**认证**: 需要登录（Token）

**请求参数**:

```json
{
  "name": "张三",
  "phone": "13800138000",
  "province": "广东省",
  "city": "深圳市",
  "district": "南山区",
  "detail": "科技园123号",
  "is_default": true
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| name | string | 是 | 收货人姓名 |
| phone | string | 是 | 联系电话 |
| province | string | 是 | 省 |
| city | string | 是 | 市 |
| district | string | 是 | 区 |
| detail | string | 是 | 详细地址 |
| is_default | boolean | 否 | 是否默认地址 |

**响应示例**:

```json
{
  "code": 0,
  "message": "创建成功",
  "data": {
    "id": 3,
    "name": "张三",
    "phone": "13800138000",
    "province": "广东省",
    "city": "深圳市",
    "district": "南山区",
    "detail": "科技园123号",
    "is_default": 1
  }
}
```

---

### 4.3 更新收货地址

更新指定的收货地址。

**接口**: `PUT /api/v1/user/addresses/{id}`

**认证**: 需要登录（Token）

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 地址 ID |

**请求参数**:

```json
{
  "name": "张三",
  "phone": "13800138000",
  "province": "广东省",
  "city": "深圳市",
  "district": "南山区",
  "detail": "科技园123号",
  "is_default": true
}
```

**响应示例**:

```json
{
  "code": 0,
  "message": "更新成功",
  "data": {
    "id": 3,
    "name": "张三",
    "phone": "13800138000",
    "province": "广东省",
    "city": "深圳市",
    "district": "南山区",
    "detail": "科技园123号",
    "is_default": 1
  }
}
```

---

### 4.4 删除收货地址

删除指定的收货地址。

**接口**: `DELETE /api/v1/user/addresses/{id}`

**认证**: 需要登录（Token）

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 地址 ID |

**响应示例**:

```json
{
  "code": 0,
  "message": "删除成功"
}
```

---

### 4.5 设置默认地址

将指定地址设为默认地址。

**接口**: `PUT /api/v1/user/addresses/{id}/default`

**认证**: 需要登录（Token）

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 地址 ID |

**响应示例**:

```json
{
  "code": 0,
  "message": "设置成功"
}
```

---

## 五、错误码说明

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权（Token 无效或过期） |
| 403 | 禁止访问（权限不足） |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

## 六、注意事项

1. **Token 管理**：
   - Token 有效期为 7 天
   - Token 过期后需要重新登录
   - 建议在前端本地存储 Token

2. **安全性**：
   - 所有需要登录的接口都必须在请求头中携带 Token
   - Token 需要通过 HTTPS 传输（生产环境）
   - 敏感信息（如手机号）需要加密传输

3. **地址管理**：
   - 每个用户最多可以有 20 个收货地址
   - 只能有一个默认地址
   - 删除默认地址后，系统会自动设置其他地址为默认

---

## 七、调试示例

### 使用 cURL

```bash
# 微信登录
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"code": "071ABCdefGHIjklMNOpqrSTUvwxYZ"}'

# 获取用户信息
curl -X GET "http://localhost:8000/api/v1/user/profile" \
  -H "Authorization: Bearer <token>"

# 创建地址
curl -X POST "http://localhost:8000/api/v1/user/addresses" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "张三",
    "phone": "13800138000",
    "province": "广东省",
    "city": "深圳市",
    "district": "南山区",
    "detail": "科技园123号"
  }'
```

---

## 八、前端对接建议

### Token 存储
```javascript
// 存储到 localStorage
wx.setStorageSync('token', data.token);

// 使用时从本地读取
const token = wx.getStorageSync('token');

// 请求时添加到 header
wx.request({
  url: url,
  header: {
    'Authorization': `Bearer ${token}`
  }
});
```

### 登录流程
```javascript
// 1. 调用微信登录
wx.login({
  success: (res) => {
    // 2. 调用后端登录接口
    wx.request({
      url: 'http://localhost:8000/api/v1/auth/login',
      method: 'POST',
      data: { code: res.code },
      success: (res) => {
        // 3. 存储 token
        wx.setStorageSync('token', res.data.data.token);
      }
    });
  }
});
```

### 获取手机号
```javascript
// 1. 用户授权
<button open-type="getPhoneNumber" bindgetphonenumber="getPhoneNumber">
  获取手机号
</button>

// 2. 解密手机号
getPhoneNumber(e) {
  const { encryptedData, iv } = e.detail;
  wx.request({
    url: 'http://localhost:8000/api/v1/auth/phone',
    method: 'POST',
    header: {
      'Authorization': `Bearer ${this.getToken()}`
    },
    data: { encryptedData, iv },
    success: (res) => {
      console.log('手机号:', res.data.data.phoneNumber);
    }
  });
}
```

# 2.2 商品模块 API 文档

## 一、概述

本文档描述商品、分类、搜索相关 API 接口。

**基础 URL**: `http://localhost:8000/api/v1`

---

## 二、分类模块

### 2.1 获取分类列表

获取所有分类（树形结构）。

**接口**: `GET /api/v1/categories`

**认证**: 无需登录

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| status | integer | 否 | 状态：0全部 1启用（默认） |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": [
    {
      "id": 1,
      "parent_id": 0,
      "name": "服装",
      "icon": "https://...",
      "sort": 1,
      "status": 1,
      "children": [
        {
          "id": 11,
          "parent_id": 1,
          "name": "男装",
          "icon": "https://...",
          "sort": 1,
          "status": 1,
          "children": []
        },
        {
          "id": 12,
          "parent_id": 1,
          "name": "女装",
          "icon": "https://...",
          "sort": 2,
          "status": 1,
          "children": []
        }
      ]
    },
    {
      "id": 2,
      "parent_id": 0,
      "name": "食品",
      "icon": "https://...",
      "sort": 2,
      "status": 1,
      "children": []
    }
  ]
}
```

---

### 2.2 获取分类详情

获取指定分类的详细信息。

**接口**: `GET /api/v1/categories/{id}`

**认证**: 无需登录

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 分类 ID |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "id": 1,
    "parent_id": 0,
    "name": "服装",
    "icon": "https://...",
    "sort": 1,
    "status": 1,
    "created_at": "2024-01-01 10:00:00"
  }
}
```

---

## 三、商品模块

### 3.1 获取商品列表

获取商品列表，支持分页、筛选、排序。

**接口**: `GET /api/v1/products`

**认证**: 无需登录

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | integer | 否 | 页码，默认 1 |
| size | integer | 否 | 每页数量，默认 20 |
| category_id | integer | 否 | 分类 ID |
| keyword | string | 否 | 搜索关键词 |
| is_hot | integer | 否 | 是否热门：0全部 1热门 |
| is_new | integer | 否 | 是否新品：0全部 1新品 |
| sort | string | 否 | 排序：default默认 price_asc价格升序 price_desc价格降序 sales销量 created最新 |
| min_price | number | 否 | 最低价格 |
| max_price | number | 否 | 最高价格 |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "total": 100,
    "page": 1,
    "size": 20,
    "pages": 5,
    "items": [
      {
        "id": 1,
        "category_id": 1,
        "name": "男士T恤",
        "subtitle": "纯棉舒适，夏季必备",
        "cover": "https://...",
        "price": 99.00,
        "original_price": 199.00,
        "stock": 100,
        "sales": 500,
        "status": 1,
        "is_hot": 1,
        "is_new": 0,
        "created_at": "2024-01-01 10:00:00"
      },
      {
        "id": 2,
        "category_id": 1,
        "name": "女士连衣裙",
        "subtitle": "时尚优雅，夏季新款",
        "cover": "https://...",
        "price": 199.00,
        "original_price": 399.00,
        "stock": 50,
        "sales": 300,
        "status": 1,
        "is_hot": 0,
        "is_new": 1,
        "created_at": "2024-01-15 10:00:00"
      }
    ]
  }
}
```

---

### 3.2 获取商品详情

获取指定商品的详细信息，包含 SKU 信息。

**接口**: `GET /api/v1/products/{id}`

**认证**: 无需登录

**路径参数**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | integer | 商品 ID |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "id": 1,
    "category_id": 1,
    "name": "男士T恤",
    "subtitle": "纯棉舒适，夏季必备",
    "cover": "https://...",
    "images": [
      "https://...",
      "https://...",
      "https://..."
    ],
    "description": "<p>商品详细描述...</p>",
    "price": 99.00,
    "original_price": 199.00,
    "stock": 100,
    "sales": 500,
    "status": 1,
    "is_hot": 1,
    "is_new": 0,
    "skus": [
      {
        "id": 1,
        "product_id": 1,
        "sku_code": "SPU001-S001",
        "specs": {
          "颜色": "白色",
          "尺码": "L"
        },
        "price": 99.00,
        "stock": 50,
        "image": "https://..."
      },
      {
        "id": 2,
        "product_id": 1,
        "sku_code": "SPU001-S002",
        "specs": {
          "颜色": "白色",
          "尺码": "XL"
        },
        "price": 99.00,
        "stock": 30,
        "image": "https://..."
      },
      {
        "id": 3,
        "product_id": 1,
        "sku_code": "SPU001-S003",
        "specs": {
          "颜色": "黑色",
          "尺码": "L"
        },
        "price": 99.00,
        "stock": 20,
        "image": "https://..."
      }
    ],
    "created_at": "2024-01-01 10:00:00"
  }
}
```

---

### 3.3 获取热门商品

获取热门商品列表（按销量排序）。

**接口**: `GET /api/v1/products/hot`

**认证**: 无需登录

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| limit | integer | 否 | 返回数量，默认 10 |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": [
    {
      "id": 1,
      "name": "男士T恤",
      "cover": "https://...",
      "price": 99.00,
      "sales": 500,
      "is_hot": 1
    },
    {
      "id": 2,
      "name": "女士连衣裙",
      "cover": "https://...",
      "price": 199.00,
      "sales": 300,
      "is_hot": 1
    }
  ]
}
```

---

### 3.4 搜索商品

搜索商品。

**接口**: `GET /api/v1/products/search`

**认证**: 无需登录

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| keyword | string | 是 | 搜索关键词 |
| page | integer | 否 | 页码，默认 1 |
| size | integer | 否 | 每页数量，默认 20 |

**响应示例**:

```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "total": 50,
    "page": 1,
    "size": 20,
    "pages": 3,
    "items": [
      {
        "id": 1,
        "name": "男士T恤",
        "cover": "https://...",
        "price": 99.00,
        "sales": 500
      }
    ]
  }
}
```

---

## 四、缓存策略

### 4.1 分类列表
- **缓存时间**: 1 小时
- **缓存键**: `category:list`
- **更新策略**: 分类修改时清除缓存

### 4.2 商品详情
- **缓存时间**: 1 小时
- **缓存键**: `product:detail:{id}`
- **更新策略**: 商品修改时清除缓存

### 4.3 商品列表
- **缓存时间**: 10 分钟
- **缓存键**: `product:list:{category}:{page}:{sort}`
- **更新策略**: 商品上架/下架时清除相关缓存

### 4.4 热门商品
- **缓存时间**: 1 小时
- **缓存键**: `product:hot`
- **数据结构**: Redis ZSet，按销量排序

---

## 五、错误码说明

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 请求参数错误 |
| 404 | 商品不存在 |
| 403 | 商品已下架 |

---

## 六、调试示例

### 使用 cURL

```bash
# 获取分类列表
curl -X GET "http://localhost:8000/api/v1/categories"

# 获取商品列表
curl -X GET "http://localhost:8000/api/v1/products?page=1&size=20&category_id=1"

# 搜索商品
curl -X GET "http://localhost:8000/api/v1/products/search?keyword=T恤"

# 获取商品详情
curl -X GET "http://localhost:8000/api/v1/products/1"

# 获取热门商品
curl -X GET "http://localhost:8000/api/v1/products/hot?limit=10"
```

---

## 七、前端对接建议

### 分类选择器
```javascript
// 获取分类列表
wx.request({
  url: 'http://localhost:8000/api/v1/categories',
  success: (res) => {
    const categories = res.data.data;
    // 渲染分类树
  }
});
```

### 商品列表（下拉刷新 + 上拉加载）
```javascript
Page({
  data: {
    products: [],
    page: 1,
    hasMore: true
  },

  loadProducts(isRefresh = false) {
    if (isRefresh) {
      this.setData({ page: 1 });
    }

    wx.request({
      url: 'http://localhost:8000/api/v1/products',
      data: {
        page: this.data.page,
        size: 20,
        category_id: this.data.categoryId
      },
      success: (res) => {
        const products = res.data.data.items;
        this.setData({
          products: isRefresh ? products : [...this.data.products, ...products],
          hasMore: products.length === 20
        });
      }
    });
  },

  onPullDownRefresh() {
    this.loadProducts(true);
    wx.stopPullDownRefresh();
  },

  onReachBottom() {
    if (this.data.hasMore) {
      this.setData({ page: this.data.page + 1 });
      this.loadProducts();
    }
  }
});
```

### 商品详情
```javascript
Page({
  onLoad(options) {
    const productId = options.id;
    this.loadProductDetail(productId);
  },

  loadProductDetail(id) {
    wx.request({
      url: `http://localhost:8000/api/v1/products/${id}`,
      success: (res) => {
        const product = res.data.data;
        this.setData({ product });
      }
    });
  }
});
```

### SKU 选择器
```javascript
// 选择 SKU
selectSku(e) {
  const skuId = e.currentTarget.dataset.id;
  const sku = this.data.product.skus.find(s => s.id === skuId);
  this.setData({
    selectedSku: sku,
    currentPrice: sku.price,
    currentStock: sku.stock
  });
}

// 添加到购物车
addToCart() {
  if (!this.data.selectedSku) {
    wx.showToast({ title: '请选择规格', icon: 'none' });
    return;
  }

  wx.request({
    url: 'http://localhost:8000/api/v1/cart',
    method: 'POST',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('token')}`
    },
    data: {
      product_id: this.data.product.id,
      sku_id: this.data.selectedSku.id,
      quantity: 1
    },
    success: (res) => {
      wx.showToast({ title: '已加入购物车' });
    }
  });
}
```

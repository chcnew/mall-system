# 5.1 测试计划

## 一、测试目标

### 1.1 功能测试
- 确保所有功能按需求正确实现
- 验证业务逻辑正确性
- 检查数据一致性

### 1.2 性能测试
- 验证系统响应时间
- 测试并发处理能力
- 检查资源使用情况

### 1.3 安全测试
- 验证认证授权机制
- 检查数据传输安全
- 测试常见漏洞

### 1.4 兼容性测试
- 验证多端兼容性
- 测试不同版本兼容性

---

## 二、测试范围

### 2.1 后端测试

#### 认证模块
- [ ] 微信登录流程
- [ ] Token 生成与验证
- [ ] Token 过期处理
- [ ] 获取手机号

#### 用户模块
- [ ] 获取用户信息
- [ ] 更新用户信息
- [ ] 地址 CRUD 操作
- [ ] 设置默认地址

#### 商品模块
- [ ] 商品列表查询
- [ ] 商品详情查询
- [ ] 商品搜索
- [ ] 分类查询
- [ ] SKU 选择

#### 订单模块
- [ ] 创建订单
- [ ] 库存锁定
- [ ] 订单列表查询
- [ ] 订单详情查询
- [ ] 取消订单
- [ ] 确认收货
- [ ] 订单状态流转

#### 支付模块
- [ ] 发起支付
- [ ] 支付回调处理
- [ ] 支付状态查询
- [ ] 防重复支付

#### 优惠券模块
- [ ] 领取优惠券
- [ ] 优惠券列表查询
- [ ] 优惠券使用
- [ ] 优惠券验证

#### 后台管理
- [ ] 管理员登录
- [ ] 商品管理 CRUD
- [ ] 订单管理与发货
- [ ] 用户管理
- [ ] 数据统计

---

### 2.2 小程序测试

#### 功能测试
- [ ] 首页加载与导航
- [ ] 分类浏览
- [ ] 商品详情展示
- [ ] SKU 选择
- [ ] 加入购物车
- [ ] 购物车操作
- [ ] 订单创建
- [ ] 支付流程
- [ ] 订单查询
- [ ] 地址管理
- [ ] 优惠券领取与使用
- [ ] 个人中心

#### 交互测试
- [ ] 下拉刷新
- [ ] 上拉加载更多
- [ ] Tab 切换
- [ ] 表单验证
- [ ] 错误提示

#### 异常测试
- [ ] 网络异常处理
- [ ] 支付失败处理
- [ ] 库存不足处理
- [ ] Token 失效处理

---

### 2.3 后台管理测试

#### 功能测试
- [ ] 登录功能
- [ ] 商品管理（增删改查）
- [ ] 订单管理与发货
- [ ] 用户管理
- [ ] 优惠券管理
- [ ] 数据统计
- [ ] 图片上传

#### 交互测试
- [ ] 表单验证
- [ ] 数据筛选
- [ ] 分页加载
- [ ] 导出功能

---

## 三、测试策略

### 3.1 单元测试

**目标**: 验证单个函数/方法正确性

**工具**: pytest

**覆盖率要求**: ≥ 80%

**测试内容**:
- 工具函数
- 业务逻辑函数
- 数据模型方法

**示例**:
```python
def test_create_order(db_session):
    user = create_test_user()
    product = create_test_product()
    order = create_order(user.id, product.id, 1)
    assert order.status == 0  # 待付款
    assert order.total_amount == product.price
```

---

### 3.2 集成测试

**目标**: 验证模块间交互正确性

**工具**: pytest + httpx

**测试内容**:
- API 接口集成
- 数据库集成
- Redis 集成
- 第三方服务集成（微信支付）

**示例**:
```python
async def test_order_payment_flow(client, db_session):
    # 创建订单
    response = await client.post("/api/v1/orders", json={...})
    assert response.status_code == 200
    order_no = response.json()["data"]["order_no"]

    # 发起支付
    response = await client.post("/api/v1/payment/prepay", json={"order_no": order_no})
    assert response.status_code == 200

    # 模拟支付回调
    response = await client.post("/api/v1/payment/notify", json={...})
    assert response.status_code == 200

    # 验证订单状态
    order = db_session.query(Order).filter_by(order_no=order_no).first()
    assert order.status == 1  # 待发货
```

---

### 3.3 性能测试

**目标**: 验证系统性能指标

**工具**: Locust / JMeter

**测试场景**:

1. **首页并发访问**
   - 虚拟用户数: 100
   - 持续时间: 5 分钟
   - 目标: 响应时间 < 500ms

2. **商品详情并发访问**
   - 虚拟用户数: 200
   - 持续时间: 5 分钟
   - 目标: 响应时间 < 300ms

3. **订单并发创建**
   - 虚拟用户数: 50
   - 持续时间: 10 分钟
   - 目标: 成功率 ≥ 99%

4. **库存并发扣减**
   - 虚拟用户数: 100
   - 目标: 无超卖

**性能指标**:
- API 响应时间: P95 < 500ms
- 并发处理能力: ≥ 100 QPS
- 数据库查询: < 100ms
- Redis 查询: < 10ms

---

### 3.4 安全测试

**目标**: 发现安全漏洞

**工具**: OWASP ZAP / Burp Suite

**测试内容**:

1. **SQL 注入测试**
   - 输入参数注入
   - 搜索功能注入
   - 排序参数注入

2. **XSS 攻击测试**
   - 富文本输入
   - 用户评论
   - 商品描述

3. **认证授权测试**
   - Token 验证
   - 权限绕过
   - 水平越权
   - 垂直越权

4. **支付安全测试**
   - 回调验签
   - 金额篡改
   - 重复支付

5. **API 安全测试**
   - 请求限流
   - 参数验证
   - 敏感信息泄露

---

## 四、测试环境

### 4.1 测试环境配置

**服务器**: 云服务器（2核4G）

**软件**:
- Docker
- MySQL 8.0
- Redis 6.0
- Nginx

**域名**: test.mall.com

**SSL**: 测试证书

---

### 4.2 数据准备

**测试数据量**:
- 用户: 1000 条
- 商品: 500 条
- 分类: 20 条
- 订单: 1000 条

**数据来源**: 自动生成脚本

---

## 五、测试执行计划

### 5.1 测试阶段

| 阶段 | 时间 | 内容 | 负责人 |
|------|------|------|--------|
| 单元测试 | Day 1-2 | 编写与执行单元测试 | 后端开发 |
| 集成测试 | Day 3 | API 集成测试 | 后端开发 |
| 小程序测试 | Day 4 | 功能测试、兼容性测试 | 前端开发 |
| 后台测试 | Day 4 | 功能测试 | 前端开发 |
| 性能测试 | Day 5 | 性能测试、压力测试 | 测试工程师 |
| 安全测试 | Day 5 | 安全漏洞扫描 | 测试工程师 |

---

### 5.2 测试交付物

1. **测试计划文档**
2. **测试用例文档**
3. **测试执行报告**
4. **缺陷报告**
5. **性能测试报告**
6. **安全测试报告**

---

## 六、缺陷管理

### 6.1 缺陷分级

| 等级 | 说明 | 示例 |
|------|------|------|
| P0 - 致命 | 系统崩溃、数据丢失 | 支付失败但金额已扣 |
| P1 - 严重 | 核心功能失效 | 无法创建订单 |
| P2 - 一般 | 次要功能失效 | 图片上传失败 |
| P3 - 轻微 | UI 问题、文案错误 | 标签显示错误 |

---

### 6.2 缺陷流程

1. 发现缺陷
2. 提交缺陷报告
3. 开发修复
4. 回归测试
5. 关闭缺陷

---

## 七、验收标准

### 7.1 功能验收
- [ ] 所有功能测试用例通过
- [ ] 无 P0/P1 级缺陷
- [ ] P2 级缺陷 < 5 个

### 7.2 性能验收
- [ ] API 响应时间 P95 < 500ms
- [ ] 并发处理能力 ≥ 100 QPS
- [ ] 无内存泄漏
- [ ] CPU 使用率 < 80%

### 7.3 安全验收
- [ ] 无高危安全漏洞
- [ ] 支付验签正常
- [ ] SQL 注入防护有效
- [ ] XSS 防护有效

---

## 八、测试工具

### 8.1 后端测试工具
- pytest: 单元测试框架
- httpx: HTTP 客户端
- Locust: 性能测试工具
- OWASP ZAP: 安全测试工具

### 8.2 小程序测试工具
- 微信开发者工具
- 真机测试（iOS、Android）

### 8.3 后台测试工具
- Chrome DevTools
- ESLint: 代码检查
- Cypress: E2E 测试（可选）

---

## 九、测试风险

### 9.1 风险识别

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 微信支付沙箱不稳定 | 支付测试失败 | 使用真实小额测试 |
| 真机测试设备不足 | 兼容性覆盖不全 | 借用测试设备 |
| 测试数据不足 | 测试场景不全 | 编写数据生成脚本 |
| 性能测试环境不足 | 无法模拟高并发 | 使用云服务 |

---

## 十、附录

### 10.1 测试用例模板

```markdown
## TC-001: 创建订单

**前置条件**:
- 用户已登录
- 商品库存充足

**测试步骤**:
1. 进入商品详情页
2. 选择规格
3. 点击"立即购买"
4. 填写地址
5. 提交订单

**预期结果**:
- 订单创建成功
- 库存锁定
- 跳转到支付页面

**实际结果**: [填写]

**测试结果**: [通过/失败]
```

---

### 10.2 性能测试脚本

```python
from locust import HttpUser, task, between

class MallUser(HttpUser):
    wait_time = between(1, 3)

    def on_start(self):
        # 登录
        response = self.client.post("/api/v1/auth/login", json={"code": "test"})
        self.token = response.json()["data"]["token"]

    @task(3)
    def view_product(self):
        self.client.get("/api/v1/products/1", headers={
            "Authorization": f"Bearer {self.token}"
        })

    @task(1)
    def create_order(self):
        self.client.post("/api/v1/orders", json={
            "address_id": 1,
            "items": [{"product_id": 1, "sku_id": 1, "quantity": 1}]
        }, headers={"Authorization": f"Bearer {self.token}"})
```

# 3.1 小程序架构设计

## 一、技术架构

### 1.1 技术栈
- 微信小程序原生开发
- 自定义组件封装
- 状态管理（本地存储）

### 1.2 开发环境
- 微信开发者工具
- 真机调试
- 模拟器测试

---

## 二、项目结构

```
miniprogram/
├── pages/                          # 页面
│   ├── index/                      # 首页
│   ├── category/                   # 分类页
│   ├── cart/                       # 购物车
│   ├── user/                       # 个人中心
│   ├── product/                    # 商品详情
│   ├── order/
│   │   ├── confirm/                # 订单确认
│   │   ├── list/                   # 订单列表
│   │   └── detail/                 # 订单详情
│   ├── address/
│   │   ├── list/                   # 地址列表
│   │   └── edit/                   # 地址编辑
│   ├── coupon/                     # 优惠券中心
│   ├── payment/                    # 支付页
│   └── search/                     # 搜索页
├── components/                     # 公共组件
│   ├── product-card/               # 商品卡片
│   ├── empty/                      # 空状态
│   ├── loading/                    # 加载中
│   ├── nav-bar/                    # 导航栏
│   └── tab-bar/                    # 自定义 TabBar
├── utils/                          # 工具函数
│   ├── request.js                  # 请求封装
│   ├── auth.js                     # 认证管理
│   ├── util.js                     # 工具函数
│   └── cache.js                    # 缓存工具
├── store/                          # 状态管理
│   ├── user.js                     # 用户状态
│   └── cart.js                     # 购物车状态
├── styles/                         # 公共样式
│   ├── common.wxss                 # 通用样式
│   └── variables.wxss              # 样式变量
├── images/                         # 图片资源
│   ├── icons/                      # 图标
│   └── tabbar/                     # 底部导航图标
├── app.js                          # 小程序入口
├── app.json                        # 全局配置
├── app.wxss                        # 全局样式
├── sitemap.json                    # 站点地图
└── project.config.json             # 项目配置
```

---

## 三、核心模块设计

### 3.1 网络请求封装（utils/request.js）

```javascript
const config = require('../config')

function request(url, options = {}) {
  return new Promise((resolve, reject) => {
    const header = {
      'Content-Type': 'application/json',
      ...options.header
    }

    // 添加 Token
    const token = wx.getStorageSync('token')
    if (token) {
      header['Authorization'] = `Bearer ${token}`
    }

    // 显示 loading
    if (options.showLoading !== false) {
      wx.showLoading({
        title: options.loadingText || '加载中...',
        mask: true
      })
    }

    wx.request({
      url: `${config.API_BASE_URL}${url}`,
      method: options.method || 'GET',
      data: options.data,
      header,
      success: (res) => {
        if (res.statusCode === 200) {
          const { code, message, data } = res.data
          if (code === 0) {
            resolve(data)
          } else {
            wx.showToast({
              title: message || '请求失败',
              icon: 'none'
            })
            reject(new Error(message))
          }
        } else if (res.statusCode === 401) {
          // Token 失效，重新登录
          wx.removeStorageSync('token')
          wx.reLaunch({ url: '/pages/index/index' })
          reject(new Error('未授权'))
        } else {
          wx.showToast({
            title: '网络错误',
            icon: 'none'
          })
          reject(new Error('网络错误'))
        }
      },
      fail: (err) => {
        wx.showToast({
          title: '网络异常',
          icon: 'none'
        })
        reject(err)
      },
      complete: () => {
        if (options.showLoading !== false) {
          wx.hideLoading()
        }
      }
    })
  })
}

module.exports = {
  get: (url, data, options) => request(url, { ...options, method: 'GET', data }),
  post: (url, data, options) => request(url, { ...options, method: 'POST', data }),
  put: (url, data, options) => request(url, { ...options, method: 'PUT', data }),
  delete: (url, data, options) => request(url, { ...options, method: 'DELETE', data })
}
```

---

### 3.2 认证管理（utils/auth.js）

```javascript
const request = require('./request')

// 微信登录
function login() {
  return new Promise((resolve, reject) => {
    wx.login({
      success: (res) => {
        request.post('/auth/login', { code: res.code })
          .then((data) => {
            // 存储 token
            wx.setStorageSync('token', data.token)
            wx.setStorageSync('openid', data.openid)
            wx.setStorageSync('session_key', data.session_key)
            resolve(data)
          })
          .catch(reject)
      },
      fail: reject
    })
  })
}

// 检查登录状态
function checkLogin() {
  const token = wx.getStorageSync('token')
  return !!token
}

// 获取 Token
function getToken() {
  return wx.getStorageSync('token')
}

// 移除 Token
function removeToken() {
  wx.removeStorageSync('token')
}

// 获取手机号
function getPhoneNumber(encryptedData, iv) {
  return request.post('/auth/phone', { encryptedData, iv })
}

module.exports = {
  login,
  checkLogin,
  getToken,
  removeToken,
  getPhoneNumber
}
```

---

### 3.3 工具函数（utils/util.js）

```javascript
// 时间格式化
function formatTime(timestamp, format = 'YYYY-MM-DD HH:mm:ss') {
  const date = new Date(timestamp)
  const formatObj = {
    YYYY: date.getFullYear(),
    MM: String(date.getMonth() + 1).padStart(2, '0'),
    DD: String(date.getDate()).padStart(2, '0'),
    HH: String(date.getHours()).padStart(2, '0'),
    mm: String(date.getMinutes()).padStart(2, '0'),
    ss: String(date.getSeconds()).padStart(2, '0')
  }

  return format.replace(/YYYY|MM|DD|HH|mm|ss/g, match => formatObj[match])
}

// 价格格式化
function formatPrice(price) {
  return `¥${Number(price).toFixed(2)}`
}

// 防抖
function debounce(fn, delay = 300) {
  let timer = null
  return function(...args) {
    if (timer) clearTimeout(timer)
    timer = setTimeout(() => {
      fn.apply(this, args)
    }, delay)
  }
}

// 节流
function throttle(fn, delay = 300) {
  let lastTime = 0
  return function(...args) {
    const now = Date.now()
    if (now - lastTime >= delay) {
      fn.apply(this, args)
      lastTime = now
    }
  }
}

module.exports = {
  formatTime,
  formatPrice,
  debounce,
  throttle
}
```

---

## 四、状态管理

### 4.1 用户状态（store/user.js）

```javascript
const app = getApp()

function getUserInfo() {
  return wx.getStorageSync('user_info') || {}
}

function setUserInfo(userInfo) {
  wx.setStorageSync('user_info', userInfo)
}

function updateUserInfo(data) {
  const userInfo = getUserInfo()
  Object.assign(userInfo, data)
  setUserInfo(userInfo)
}

function clearUserInfo() {
  wx.removeStorageSync('user_info')
}

module.exports = {
  getUserInfo,
  setUserInfo,
  updateUserInfo,
  clearUserInfo
}
```

---

## 五、页面生命周期

### 5.1 标准页面结构

```javascript
const app = getApp()
const request = require('../../utils/request')
const auth = require('../../utils/auth')

Page({
  data: {},

  onLoad(options) {
    // 页面加载
    this.init(options)
  },

  onReady() {
    // 页面首次渲染完成
  },

  onShow() {
    // 页面显示
    this.refresh()
  },

  onHide() {
    // 页面隐藏
  },

  onUnload() {
    // 页面卸载
  },

  onPullDownRefresh() {
    // 下拉刷新
    this.loadData().finally(() => {
      wx.stopPullDownRefresh()
    })
  },

  onReachBottom() {
    // 上拉加载更多
    if (this.data.hasMore) {
      this.loadMore()
    }
  },

  onShareAppMessage() {
    // 分享
    return {
      title: '微信商城',
      path: '/pages/index/index'
    }
  },

  init(options) {
    // 初始化
  },

  refresh() {
    // 刷新数据
  },

  loadData() {
    // 加载数据
    return Promise.resolve()
  },

  loadMore() {
    // 加载更多
  }
})
```

---

## 六、性能优化

### 6.1 图片优化
- 使用 CDN 加速
- 图片懒加载
- 图片压缩（webp 格式）

### 6.2 数据优化
- 分页加载
- 列表虚拟化
- setData 优化（减少数据量）

### 6.3 缓存策略
- 本地存储
- 请求缓存
- 图片缓存

---

## 七、安全建议

### 7.1 数据安全
- 敏感数据加密传输
- Token 安全存储
- 避免 XSS 攻击

### 7.2 请求安全
- HTTPS 传输
- 请求签名
- 防重放攻击

---

## 八、开发规范

### 8.1 命名规范
- 页面：小写，短横线分隔
- 组件：小写，短横线分隔
- 函数：驼峰命名
- 变量：驼峰命名

### 8.2 代码风格
- 使用 2 空格缩进
- 单引号优先
- 必要时添加注释

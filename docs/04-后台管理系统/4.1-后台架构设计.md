# 4.1 后台架构设计

## 一、技术架构

### 1.1 技术栈
- Vue 3 (Composition API)
- TypeScript
- Vite (构建工具)
- Element Plus (UI 组件库)
- Pinia (状态管理)
- Vue Router
- Axios
- ECharts (数据可视化)
- @vueuse/core (组合式工具)

---

## 二、项目结构

```
admin/
├── src/
│   ├── api/                        # API 接口
│   │   ├── index.ts                 # axios 实例
│   │   ├── auth.ts                  # 认证接口
│   │   ├── product.ts               # 商品接口
│   │   ├── order.ts                 # 订单接口
│   │   ├── user.ts                  # 用户接口
│   │   ├── coupon.ts                # 优惠券接口
│   │   └── statistics.ts            # 统计接口
│   ├── assets/                      # 静态资源
│   │   ├── images/
│   │   └── styles/
│   ├── components/                  # 公共组件
│   │   ├── Header/                  # 顶部导航
│   │   ├── Sidebar/                 # 侧边栏
│   │   ├── Breadcrumb/              # 面包屑
│   │   ├── UploadImage/             # 图片上传
│   │   └── RichTextEditor/          # 富文本编辑器
│   ├── composables/                 # 组合函数
│   │   ├── useTable.ts              # 表格处理
│   │   ├── useForm.ts               # 表单处理
│   │   └── useDialog.ts             # 对话框处理
│   ├── layout/                      # 布局组件
│   │   ├── AppLayout.vue            # 主布局
│   │   ├── components/              # 布局子组件
│   ├── router/                      # 路由配置
│   │   └── index.ts
│   ├── store/                       # Pinia 状态
│   │   ├── index.ts
│   │   ├── modules/
│   │   │   ├── user.ts              # 用户状态
│   │   │   ├── app.ts               # 应用状态
│   │   │   └── settings.ts          # 设置状态
│   ├── styles/                      # 样式
│   │   ├── index.scss               # 全局样式
│   │   ├── variables.scss           # 样式变量
│   │   └── mixins.scss              # 样式混入
│   ├── utils/                       # 工具函数
│   │   ├── request.ts               # 请求封装
│   │   ├── auth.ts                  # 认证工具
│   │   ├── format.ts                # 格式化工具
│   │   └── validate.ts              # 验证规则
│   ├── views/                       # 页面视图
│   │   ├── login/                   # 登录页
│   │   ├── dashboard/               # 控制台
│   │   ├── product/                 # 商品管理
│   │   │   ├── list.vue
│   │   │   └── edit.vue
│   │   ├── order/                   # 订单管理
│   │   │   ├── list.vue
│   │   │   └── detail.vue
│   │   ├── user/                    # 用户管理
│   │   │   └── list.vue
│   │   ├── marketing/               # 营销管理
│   │   │   └── coupon/
│   │   └── system/                  # 系统设置
│   ├── App.vue                      # 根组件
│   └── main.ts                      # 入口文件
├── index.html
├── vite.config.ts                   # Vite 配置
├── tsconfig.json                    # TypeScript 配置
├── package.json
└── tsconfig.node.json
```

---

## 三、核心配置

### 3.1 Vite 配置（vite.config.ts）

```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    }
  },
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  },
  build: {
    target: 'es2015',
    outDir: 'dist',
    assetsDir: 'assets',
    sourcemap: false,
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true
      }
    }
  }
})
```

---

### 3.2 TypeScript 配置（tsconfig.json）

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "preserve",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*.ts", "src/**/*.d.ts", "src/**/*.tsx", "src/**/*.vue"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

---

## 四、核心模块

### 4.1 请求封装（utils/request.ts）

```typescript
import axios, { AxiosInstance, AxiosRequestConfig, AxiosResponse } from 'axios'
import { ElMessage, ElMessageBox } from 'element-plus'
import { useUserStore } from '@/store/modules/user'

const instance: AxiosInstance = axios.create({
  baseURL: '/api',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// 请求拦截器
instance.interceptors.request.use(
  (config: AxiosRequestConfig) => {
    const userStore = useUserStore()
    if (userStore.token) {
      config.headers.Authorization = `Bearer ${userStore.token}`
    }
    return config
  },
  (error) => {
    return Promise.reject(error)
  }
)

// 响应拦截器
instance.interceptors.response.use(
  (response: AxiosResponse) => {
    const { code, message, data } = response.data
    if (code === 0) {
      return data
    } else if (code === 401) {
      ElMessageBox.alert('登录已过期，请重新登录', '提示', {
        confirmButtonText: '确定',
        callback: () => {
          const userStore = useUserStore()
          userStore.logout()
          window.location.href = '/login'
        }
      })
      return Promise.reject(new Error(message))
    } else {
      ElMessage.error(message || '请求失败')
      return Promise.reject(new Error(message))
    }
  },
  (error) => {
    ElMessage.error(error.message || '网络错误')
    return Promise.reject(error)
  }
)

export default instance
```

---

### 4.2 路由配置（router/index.ts）

```typescript
import { createRouter, createWebHistory, RouteRecordRaw } from 'vue-router'
import Layout from '@/layout/AppLayout.vue'
import { useUserStore } from '@/store/modules/user'

const routes: RouteRecordRaw[] = [
  {
    path: '/login',
    name: 'Login',
    component: () => import('@/views/login/index.vue'),
    meta: { requiresAuth: false }
  },
  {
    path: '/',
    component: Layout,
    redirect: '/dashboard',
    meta: { requiresAuth: true },
    children: [
      {
        path: 'dashboard',
        name: 'Dashboard',
        component: () => import('@/views/dashboard/index.vue'),
        meta: { title: '控制台' }
      },
      {
        path: 'product',
        name: 'Product',
        component: () => import('@/views/product/list.vue'),
        meta: { title: '商品管理' }
      },
      {
        path: 'product/edit/:id?',
        name: 'ProductEdit',
        component: () => import('@/views/product/edit.vue'),
        meta: { title: '商品编辑' }
      },
      {
        path: 'order',
        name: 'Order',
        component: () => import('@/views/order/list.vue'),
        meta: { title: '订单管理' }
      },
      {
        path: 'order/detail/:id',
        name: 'OrderDetail',
        component: () => import('@/views/order/detail.vue'),
        meta: { title: '订单详情' }
      }
    ]
  }
]

const router = createRouter({
  history: createWebHistory(),
  routes
})

// 路由守卫
router.beforeEach((to, from, next) => {
  const userStore = useUserStore()
  const requiresAuth = to.meta.requiresAuth !== false

  if (requiresAuth && !userStore.token) {
    next('/login')
  } else if (to.path === '/login' && userStore.token) {
    next('/')
  } else {
    next()
  }
})

export default router
```

---

### 4.3 Pinia 状态（store/modules/user.ts）

```typescript
import { defineStore } from 'pinia'
import { login as loginApi, getUserInfo as getUserInfoApi } from '@/api/auth'

interface User {
  id: number
  username: string
  nickname: string
  avatar?: string
  role: string
}

interface UserState {
  token: string
  user: User | null
}

export const useUserStore = defineStore('user', {
  state: (): UserState => ({
    token: localStorage.getItem('admin_token') || '',
    user: null
  }),

  getters: {
    isLoggedIn: (state) => !!state.token
  },

  actions: {
    // 登录
    async login(loginForm: { username: string; password: string }) {
      const data = await loginApi(loginForm)
      this.token = data.token
      this.user = data.admin
      localStorage.setItem('admin_token', data.token)
    },

    // 获取用户信息
    async getUserInfo() {
      const data = await getUserInfoApi()
      this.user = data
    },

    // 登出
    logout() {
      this.token = ''
      this.user = null
      localStorage.removeItem('admin_token')
    }
  }
})
```

---

## 五、组合函数

### 5.1 表格处理（composables/useTable.ts）

```typescript
import { ref, reactive, onMounted } from 'vue'
import { ElMessage } from 'element-plus'

export function useTable<T>(apiFunction: Function) {
  const tableData = ref<T[]>([])
  const loading = ref(false)
  const pagination = reactive({
    page: 1,
    size: 20,
    total: 0
  })
  const queryParams = reactive<any>({})

  // 加载数据
  const loadData = async () => {
    loading.value = true
    try {
      const data = await apiFunction({
        ...queryParams,
        page: pagination.page,
        size: pagination.size
      })
      tableData.value = data.items
      pagination.total = data.total
    } catch (error) {
      ElMessage.error('加载数据失败')
    } finally {
      loading.value = false
    }
  }

  // 页码变化
  const handlePageChange = (page: number) => {
    pagination.page = page
    loadData()
  }

  // 每页数量变化
  const handleSizeChange = (size: number) => {
    pagination.size = size
    pagination.page = 1
    loadData()
  }

  // 搜索
  const handleSearch = (params: any) => {
    Object.assign(queryParams, params)
    pagination.page = 1
    loadData()
  }

  // 重置
  const handleReset = () => {
    Object.keys(queryParams).forEach(key => {
      delete queryParams[key]
    })
    pagination.page = 1
    loadData()
  }

  onMounted(() => {
    loadData()
  })

  return {
    tableData,
    loading,
    pagination,
    queryParams,
    loadData,
    handlePageChange,
    handleSizeChange,
    handleSearch,
    handleReset
  }
}
```

---

## 六、性能优化

### 6.1 路由懒加载
```typescript
const routes = [
  {
    path: '/product',
    component: () => import('@/views/product/index.vue')
  }
]
```

### 6.2 组件懒加载
```typescript
const AsyncComponent = defineAsyncComponent(() => import('./Component.vue'))
```

### 6.3 打包优化
```typescript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'element-plus': ['element-plus'],
          'echarts': ['echarts']
        }
      }
    }
  }
})
```

---

## 七、安全建议

### 7.1 XSS 防护
- 使用 Vue 的模板插值（自动转义）
- 避免使用 v-html
- 对用户输入进行验证

### 7.2 CSRF 防护
- 使用 Token 验证
- 检查 Referer

---

## 八、开发规范

### 8.1 代码风格
- 使用 ESLint + Prettier
- 2 空格缩进
- 单引号优先
- 必要时添加注释

### 8.2 命名规范
- 组件：PascalCase
- 函数：camelCase
- 变量：camelCase
- 常量：UPPER_SNAKE_CASE

# 1.1 后端架构设计

## 一、技术选型

### 1.1 Web 框架
**FastAPI**

选择理由：
- 现代化的 Python Web 框架，支持异步
- 自动生成 OpenAPI (Swagger) 文档
- 类型提示支持，开发体验好
- 性能优秀（与 NodeJS 和 Go 相当）
- 内置数据验证（Pydantic）

### 1.2 数据库 ORM
**SQLAlchemy 2.0**

选择理由：
- 成熟的 Python ORM 框架
- 支持 2.0 新特性（async/await）
- 强大的查询能力
- 良好的数据库迁移支持（Alembic）

### 1.3 缓存
**Redis**

选择理由：
- 高性能内存数据库
- 丰富的数据结构
- 支持持久化
- 用于会话缓存、商品缓存、分布式锁

### 1.4 异步任务
**Celery**

选择理由：
- 成熟的任务队列框架
- 支持定时任务
- 与 Redis 良好集成
- 用于订单超时取消、物流查询等

### 1.5 支付集成
**WeChat Pay v3 (wechatpayv3)**

选择理由：
- 官方 Python SDK
- 支持 API v3
- 自动处理签名

## 二、项目结构

```
backend/
├── app/                          # 应用主目录
│   ├── __init__.py              # 应用包初始化
│   ├── main.py                  # FastAPI 应用入口
│   │
│   ├── core/                    # 核心配置
│   │   ├── __init__.py
│   │   ├── config.py            # 配置管理（读取 .env）
│   │   ├── security.py          # 安全相关（JWT、密码哈希）
│   │   ├── deps.py              # 依赖注入（get_db、get_redis、get_current_user）
│   │   └── exceptions.py        # 自定义异常与异常处理
│   │
│   ├── db/                      # 数据库相关
│   │   ├── __init__.py
│   │   ├── base.py              # SQLAlchemy Base、引擎创建
│   │   ├── session.py           # Session 本地线程管理
│   │   └── redis_client.py      # Redis 客户端封装
│   │
│   ├── api/                     # API 路由
│   │   ├── __init__.py
│   │   ├── v1/                  # 小程序端 API v1
│   │   │   ├── __init__.py
│   │   │   ├── auth.py          # 认证接口（登录、手机号）
│   │   │   ├── user.py          # 用户接口（信息、地址）
│   │   │   ├── product.py       # 商品接口（列表、详情、搜索）
│   │   │   ├── category.py      # 分类接口
│   │   │   ├── cart.py          # 购物车接口
│   │   │   ├── order.py         # 订单接口（创建、查询、状态）
│   │   │   ├── payment.py       # 支付接口（预下单、回调、查询）
│   │   │   ├── coupon.py        # 优惠券接口
│   │   │   └── common.py        # 公共接口（轮播图、上传）
│   │   └── admin/               # 管理端 API
│   │       ├── __init__.py
│   │       ├── auth.py          # 管理员登录
│   │       ├── product.py       # 商品管理
│   │       ├── category.py      # 分类管理
│   │       ├── order.py         # 订单管理
│   │       ├── user.py          # 用户管理
│   │       ├── coupon.py        # 优惠券管理
│   │       ├── statistics.py    # 数据统计
│   │       ├── banner.py        # 轮播图管理
│   │       └── system.py        # 系统配置
│   │
│   ├── models/                  # SQLAlchemy 模型
│   │   ├── __init__.py          # 导入所有模型
│   │   ├── user.py              # User、UserAddress
│   │   ├── product.py           # Category、Product、ProductSku
│   │   ├── order.py             # Order、OrderItem、OrderLogistics
│   │   ├── marketing.py         # CouponTemplate、UserCoupon
│   │   ├── cart.py              # Cart
│   │   └── system.py            # Admin、SystemConfig、Banner
│   │
│   ├── schemas/                 # Pydantic 模式（请求/响应模型）
│   │   ├── __init__.py
│   │   ├── user.py              # 用户相关 Schema
│   │   ├── address.py           # 地址相关 Schema
│   │   ├── product.py           # 商品相关 Schema
│   │   ├── category.py          # 分类相关 Schema
│   │   ├── cart.py              # 购物车相关 Schema
│   │   ├── order.py             # 订单相关 Schema
│   │   ├── payment.py           # 支付相关 Schema
│   │   ├── coupon.py            # 优惠券相关 Schema
│   │   └── response.py          # 通用响应 Schema
│   │
│   ├── services/                # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── user_service.py      # 用户业务逻辑
│   │   ├── product_service.py   # 商品业务逻辑
│   │   ├── order_service.py     # 订单业务逻辑
│   │   ├── payment_service.py   # 支付业务逻辑
│   │   ├── coupon_service.py    # 优惠券业务逻辑
│   │   └── cart_service.py      # 购物车业务逻辑
│   │
│   ├── utils/                   # 工具函数
│   │   ├── __init__.py
│   │   ├── logger.py            # 日志配置
│   │   ├── wechat.py            # 微信 API 封装
│   │   ├── wechat_pay.py        # 微信支付封装
│   │   ├── sms.py               # 短信服务（预留）
│   │   ├── cache.py             # 缓存装饰器
│   │   ├── order.py             # 订单工具（生成订单号等）
│   │   └── stock.py             # 库存管理工具
│   │
│   └── tasks/                   # Celery 异步任务
│       ├── __init__.py
│       ├── celery_app.py        # Celery 应用配置
│       ├── order_tasks.py       # 订单相关任务（超时取消）
│       └── logistics_tasks.py   # 物流相关任务（物流查询）
│
├── alembic/                     # 数据库迁移
│   ├── versions/                # 迁移版本文件
│   ├── env.py                   # 迁移环境配置
│   └── script.py.mako           # 迁移脚本模板
│
├── scripts/                     # 脚本工具
│   └── init_data.py             # 初始化数据脚本
│
├── tests/                       # 测试
│   ├── conftest.py              # pytest 配置
│   ├── test_api/                # API 测试
│   └── test_utils/              # 工具函数测试
│
├── requirements.txt             # Python 依赖
├── Dockerfile                   # Docker 镜像构建
├── .env.example                 # 环境变量模板
└── README.md                    # 后端说明文档
```

## 三、核心模块说明

### 3.1 应用入口 (main.py)

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.core.config import settings
from app.api.v1 import api_router
from app.api.admin import admin_router
from app.db.session import engine
from app.db.base import Base

app = FastAPI(
    title=settings.PROJECT_NAME,
    version=settings.VERSION,
    openapi_url=f"{settings.API_V1_STR}/openapi.json"
)

# CORS 配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.ALLOWED_HOSTS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 注册路由
app.include_router(api_router, prefix=settings.API_V1_STR)
app.include_router(admin_router, prefix="/api/admin")

@app.on_event("startup")
def on_startup():
    # 创建数据库表（开发环境）
    Base.metadata.create_all(bind=engine)

@app.get("/")
def read_root():
    return {"message": "微信商城小程序系统 API"}
```

### 3.2 配置管理 (core/config.py)

```python
from pydantic_settings import BaseSettings
from typing import Optional

class Settings(BaseSettings):
    # 项目信息
    PROJECT_NAME: str = "微信商城小程序系统"
    VERSION: str = "1.0.0"
    API_V1_STR: str = "/api/v1"

    # 数据库
    DATABASE_URL: str = "mysql+pymysql://user:password@localhost/mall_db"

    # Redis
    REDIS_URL: str = "redis://localhost:6379/0"

    # JWT
    SECRET_KEY: str = "your-secret-key"
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 10080  # 7天

    # 微信
    WECHAT_APP_ID: str
    WECHAT_APP_SECRET: str
    WECHAT_MCH_ID: str
    WECHAT_API_V3_KEY: str
    WECHAT_CERT_PATH: str
    WECHAT_KEY_PATH: str
    WECHAT_NOTIFY_URL: str

    # CORS
    ALLOWED_HOSTS: list = ["*"]

    # OSS
    OSS_ACCESS_KEY_ID: str
    OSS_ACCESS_KEY_SECRET: str
    OSS_BUCKET_NAME: str
    OSS_ENDPOINT: str

    class Config:
        env_file = ".env"

settings = Settings()
```

### 3.3 依赖注入 (core/deps.py)

```python
from typing import Generator
from fastapi import Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from jose import jwt
from sqlalchemy.orm import Session
from app.db.session import SessionLocal
from app.core.config import settings
from app.core.security import verify_token
from app.models.user import User
from app.db.redis_client import redis_client

# 数据库依赖
def get_db() -> Generator:
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

# Redis 依赖
def get_redis():
    return redis_client

# JWT 验证依赖
oauth2_scheme = OAuth2PasswordBearer(tokenUrl=f"{settings.API_V1_STR}/auth/login")

async def get_current_user(
    token: str = Depends(oauth2_scheme),
    db: Session = Depends(get_db)
) -> User:
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="无法验证凭据",
    )
    payload = verify_token(token)
    openid: str = payload.get("sub")
    if openid is None:
        raise credentials_exception

    user = db.query(User).filter(User.openid == openid).first()
    if user is None:
        raise credentials_exception
    return user
```

### 3.4 安全相关 (core/security.py)

```python
from datetime import datetime, timedelta
from typing import Optional
from jose import jwt
from passlib.context import CryptContext
from app.core.config import settings

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)

def get_password_hash(password: str) -> str:
    return pwd_context.hash(password)

def create_access_token(data: dict, expires_delta: Optional[timedelta] = None):
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)
    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, settings.SECRET_KEY, algorithm=settings.ALGORITHM)
    return encoded_jwt

def verify_token(token: str):
    try:
        payload = jwt.decode(token, settings.SECRET_KEY, algorithms=[settings.ALGORITHM])
        return payload
    except jwt.JWTError:
        return None
```

## 四、中间件配置

### 4.1 请求日志中间件
```python
import time
import logging
from fastapi import Request

@app.middleware("http")
async def log_requests(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time
    logging.info(
        f"{request.method} {request.url} - "
        f"Status: {response.status_code} - "
        f"Time: {process_time:.3f}s"
    )
    return response
```

### 4.2 异常处理中间件
```python
from fastapi import Request
from fastapi.responses import JSONResponse

@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    logging.error(f"Unhandled exception: {exc}")
    return JSONResponse(
        status_code=500,
        content={"code": 500, "message": "服务器内部错误"}
    )
```

## 五、数据库连接

### 5.1 数据库引擎 (db/session.py)
```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from app.core.config import settings

engine = create_engine(
    settings.DATABASE_URL,
    pool_pre_ping=True,
    pool_size=10,
    max_overflow=20,
    echo=False  # 生产环境设为 False
)

SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
```

### 5.2 Redis 客户端 (db/redis_client.py)
```python
import redis
from app.core.config import settings

redis_client = redis.Redis(
    host=settings.REDIS_HOST,
    port=settings.REDIS_PORT,
    db=settings.REDIS_DB,
    decode_responses=True,
    max_connections=20
)
```

## 六、日志配置

```python
import logging
from pathlib import Path

log_dir = Path("logs")
log_dir.mkdir(exist_ok=True)

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    handlers=[
        logging.FileHandler(log_dir / "app.log"),
        logging.StreamHandler()
    ]
)
```

## 七、架构设计原则

### 7.1 分层架构
- **API 层**：处理 HTTP 请求/响应，参数验证
- **Service 层**：业务逻辑处理
- **Model 层**：数据模型定义
- **Utils 层**：工具函数封装

### 7.2 依赖注入
使用 FastAPI 的依赖注入系统：
- 数据库会话
- Redis 连接
- 当前用户

### 7.3 缓存策略
- **商品详情**：1 小时
- **商品列表**：10 分钟
- **用户 Token**：7 天
- **购物车**：持久化
- **订单锁**：5 分钟

### 7.4 异步处理
- 订单超时取消
- 物流信息更新
- 优惠券过期处理

## 八、性能优化

### 8.1 数据库优化
- 合理使用索引
- 查询优化（避免 N+1）
- 连接池配置

### 8.2 缓存优化
- 热点数据缓存
- 缓存预热
- 缓存更新策略

### 8.3 异步处理
- 使用 FastAPI 异步特性
- Celery 异步任务
- Redis 分布式锁

## 九、安全设计

### 9.1 认证授权
- JWT Token 认证
- Token 有效期控制
- Token 刷新机制

### 9.2 数据安全
- 密码哈希存储
- 敏感信息加密
- SQL 注入防护

### 9.3 API 安全
- 请求频率限制
- 参数验证
- 跨域配置

## 十、API 文档

FastAPI 自动生成 Swagger UI：
- 访问地址：`http://localhost:8000/docs`
- 包含所有接口的详细说明
- 支持在线测试

---

## 总结

本后端架构采用现代化的技术栈和分层设计，具有以下特点：

1. **高性能**：异步处理 + 缓存优化
2. **可维护**：清晰的分层架构
3. **可扩展**：模块化设计
4. **易开发**：自动生成文档、类型提示
5. **高可用**：连接池、分布式锁、异步任务

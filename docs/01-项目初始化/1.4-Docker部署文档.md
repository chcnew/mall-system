# 1.4 Docker 部署文档

## 一、Docker 部署概述

### 1.1 部署架构

```
┌─────────────────────────────────────────────────┐
│                   Nginx                          │
│  (反向代理、静态资源、SSL、负载均衡)             │
└──────────────────┬──────────────────────────────┘
                   │
        ┌──────────┼──────────┐
        │          │          │
        ▼          ▼          ▼
┌─────────────┐ ┌──────────┐ ┌──────────┐
│  Backend    │ │  Admin    │ │  Static  │
│  (FastAPI)  │ │  (Vue3)   │ │  (Files) │
└──────┬──────┘ └──────────┘ └──────────┘
       │
       ├─────────────┐
       │             │
       ▼             ▼
┌──────────┐  ┌──────────┐
│  MySQL   │  │  Redis   │
└──────────┘  └──────────┘
```

### 1.2 服务列表

| 服务名 | 端口 | 说明 |
|--------|------|------|
| Nginx | 80, 443 | 反向代理、静态文件服务 |
| Backend | 8000 | FastAPI 后端服务 |
| Admin | 80 | Vue3 后台管理（通过 Nginx） |
| MySQL | 3306 | 数据库 |
| Redis | 6379 | 缓存 |
| Celery Worker | - | 异步任务处理 |
| Flower | 5555 | Celery 监控（可选） |

---

## 二、Docker 镜像构建

### 2.1 后端 Dockerfile

```dockerfile
# backend/Dockerfile
FROM python:3.10-slim

# 设置工作目录
WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    default-libmysqlclient-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装 Python 依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 创建日志目录
RUN mkdir -p logs

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

### 2.2 后台管理 Dockerfile

```dockerfile
# admin/Dockerfile

# 构建阶段
FROM node:18-alpine AS builder

WORKDIR /app

# 复制依赖文件
COPY package*.json ./

# 安装依赖
RUN npm ci

# 复制源代码
COPY . .

# 构建生产版本
RUN npm run build

# 生产阶段
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/dist /usr/share/nginx/html

# 复制 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 暴露端口
EXPOSE 80

# 启动 Nginx
CMD ["nginx", "-g", "daemon off;"]
```

---

### 2.3 Nginx 配置

```nginx
# nginx/nginx.conf

# 后端 API 代理
server {
    listen 80;
    server_name api.your-domain.com;

    client_max_body_size 100M;

    location / {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
    }
}

# 后台管理前端
server {
    listen 80;
    server_name admin.your-domain.com;

    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api {
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 静态资源缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

---

## 三、Docker Compose 配置

### 3.1 开发环境 docker-compose.yml

```yaml
# docker-compose.yml
version: '3.8'

services:
  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: mall_mysql_dev
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-mall_db}
      MYSQL_USER: ${MYSQL_USER:-mall_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-mall_password}
    ports:
      - "3306:3306"
    volumes:
      - mysql_dev_data:/var/lib/mysql
      - ./backend/scripts/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mall_network
    command: --default-authentication-plugin=mysql_native_password

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: mall_redis_dev
    ports:
      - "6379:6379"
    volumes:
      - redis_dev_data:/data
    networks:
      - mall_network
    command: redis-server --appendonly yes

  # 后端服务
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mall_backend_dev
    environment:
      DATABASE_URL: mysql+pymysql://${MYSQL_USER:-mall_user}:${MYSQL_PASSWORD:-mall_password}@mysql:3306/${MYSQL_DATABASE:-mall_db}
      REDIS_URL: redis://redis:6379/0
      DEBUG: "True"
      SECRET_KEY: ${SECRET_KEY:-dev-secret-key}
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - backend_logs:/app/logs
    depends_on:
      - mysql
      - redis
    networks:
      - mall_network
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # Celery Worker
  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mall_celery_worker_dev
    environment:
      DATABASE_URL: mysql+pymysql://${MYSQL_USER:-mall_user}:${MYSQL_PASSWORD:-mall_password}@mysql:3306/${MYSQL_DATABASE:-mall_db}
      REDIS_URL: redis://redis:6379/0
    depends_on:
      - mysql
      - redis
    volumes:
      - ./backend:/app
      - backend_logs:/app/logs
    networks:
      - mall_network
    command: celery -A app.tasks.celery_app worker --loglevel=info

  # Flower (Celery 监控)
  flower:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mall_flower_dev
    environment:
      REDIS_URL: redis://redis:6379/0
    ports:
      - "5555:5555"
    depends_on:
      - redis
    networks:
      - mall_network
    command: celery -A app.tasks.celery_app flower --port=5555

volumes:
  mysql_dev_data:
  redis_dev_data:
  backend_logs:

networks:
  mall_network:
    driver: bridge
```

---

### 3.2 生产环境 docker-compose.prod.yml

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  # MySQL 数据库（主从复制）
  mysql-master:
    image: mysql:8.0
    container_name: mall_mysql_master
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_master_data:/var/lib/mysql
      - ./mysql/conf.d/master.cnf:/etc/mysql/conf.d/master.cnf
    networks:
      - mall_prod_network
    command: --server-id=1 --log-bin=mysql-bin --binlog-format=ROW

  mysql-slave:
    image: mysql:8.0
    container_name: mall_mysql_slave
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_slave_data:/var/lib/mysql
      - ./mysql/conf.d/slave.cnf:/etc/mysql/conf.d/slave.cnf
    networks:
      - mall_prod_network
    depends_on:
      - mysql-master
    command: --server-id=2 --relay-log=relay-bin --read-only=1

  # Redis 集群
  redis-master:
    image: redis:7-alpine
    container_name: mall_redis_master
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_master_data:/data
    networks:
      - mall_prod_network

  redis-slave:
    image: redis:7-alpine
    container_name: mall_redis_slave
    command: redis-server --slaveof redis-master 6379 --masterauth ${REDIS_PASSWORD}
    volumes:
      - redis_slave_data:/data
    networks:
      - mall_prod_network
    depends_on:
      - redis-master

  # 后端服务（多实例）
  backend1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mall_backend_1
    environment:
      DATABASE_URL: mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@mysql-master:3306/${MYSQL_DATABASE}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis-master:6379/0
      DEBUG: "False"
      SECRET_KEY: ${SECRET_KEY}
    depends_on:
      - mysql-master
      - redis-master
    networks:
      - mall_prod_network
    restart: always

  backend2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mall_backend_2
    environment:
      DATABASE_URL: mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@mysql-master:3306/${MYSQL_DATABASE}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis-master:6379/0
      DEBUG: "False"
      SECRET_KEY: ${SECRET_KEY}
    depends_on:
      - mysql-master
      - redis-master
    networks:
      - mall_prod_network
    restart: always

  # Celery Worker（多实例）
  celery_worker1:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mall_celery_worker_1
    environment:
      DATABASE_URL: mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@mysql-master:3306/${MYSQL_DATABASE}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis-master:6379/0
    depends_on:
      - mysql-master
      - redis-master
    networks:
      - mall_prod_network
    command: celery -A app.tasks.celery_app worker --loglevel=info --concurrency=4
    restart: always

  celery_worker2:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mall_celery_worker_2
    environment:
      DATABASE_URL: mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@mysql-master:3306/${MYSQL_DATABASE}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis-master:6379/0
    depends_on:
      - mysql-master
      - redis-master
    networks:
      - mall_prod_network
    command: celery -A app.tasks.celery_app worker --loglevel=info --concurrency=4
    restart: always

  # 后台管理前端
  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: mall_admin
    networks:
      - mall_prod_network
    restart: always

  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: mall_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - admin_static:/usr/share/nginx/html
    depends_on:
      - backend1
      - backend2
      - admin
    networks:
      - mall_prod_network
    restart: always

volumes:
  mysql_master_data:
  mysql_slave_data:
  redis_master_data:
  redis_slave_data:
  admin_static:

networks:
  mall_prod_network:
    driver: bridge
```

---

## 四、环境变量配置

### 4.1 创建 .env.prod 文件

```bash
# 生产环境变量
# 数据库配置
MYSQL_ROOT_PASSWORD=your_strong_password
MYSQL_DATABASE=mall_prod_db
MYSQL_USER=mall_prod_user
MYSQL_PASSWORD=your_strong_password

# Redis 配置
REDIS_PASSWORD=your_strong_redis_password

# 应用配置
SECRET_KEY=your_production_secret_key
DEBUG=False

# 微信配置
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret

# 微信支付配置
WECHAT_MCH_ID=your_mch_id
WECHAT_API_V3_KEY=your_api_v3_key

# OSS 配置
OSS_ACCESS_KEY_ID=your_oss_access_key_id
OSS_ACCESS_KEY_SECRET=your_oss_access_key_secret
OSS_BUCKET_NAME=your_bucket_name
OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com
```

---

## 五、部署流程

### 5.1 开发环境部署

```bash
# 1. 克隆项目
git clone <repository-url>
cd mall-system

# 2. 创建 .env 文件
cp .env.example .env

# 3. 修改 .env 配置

# 4. 启动所有服务
docker-compose up -d

# 5. 查看服务状态
docker-compose ps

# 6. 查看日志
docker-compose logs -f backend

# 7. 执行数据库迁移
docker-compose exec backend alembic upgrade head

# 8. 初始化数据
docker-compose exec backend python scripts/init_data.py

# 9. 访问服务
# API 文档: http://localhost:8000/docs
# 后台管理: http://localhost:8000/admin
# Flower: http://localhost:5555
```

---

### 5.2 生产环境部署

```bash
# 1. 配置生产环境变量
cp .env.example .env.prod
vim .env.prod

# 2. 配置 Nginx SSL 证书
mkdir -p nginx/ssl
# 将 SSL 证书复制到 nginx/ssl 目录

# 3. 配置 Nginx
vim nginx/nginx.conf

# 4. 构建镜像
docker-compose -f docker-compose.prod.yml build

# 5. 启动服务
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d

# 6. 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 7. 执行数据库迁移
docker-compose -f docker-compose.prod.yml exec backend1 alembic upgrade head

# 8. 初始化数据
docker-compose -f docker-compose.prod.yml exec backend1 python scripts/init_data.py

# 9. 配置防火墙
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 10. 配置域名解析
# 将域名解析到服务器 IP
```

---

## 六、常用 Docker 命令

### 6.1 容器管理

```bash
# 查看运行中的容器
docker ps

# 查看所有容器（包括停止的）
docker ps -a

# 查看容器日志
docker logs <container_name>

# 实时查看日志
docker logs -f <container_name>

# 进入容器
docker exec -it <container_name> /bin/bash

# 停止容器
docker stop <container_name>

# 启动容器
docker start <container_name>

# 重启容器
docker restart <container_name>

# 删除容器
docker rm <container_name>

# 强制删除运行中的容器
docker rm -f <container_name>
```

---

### 6.2 镜像管理

```bash
# 查看镜像
docker images

# 构建镜像
docker build -t <image_name> .

# 删除镜像
docker rmi <image_id>

# 删除所有未使用的镜像
docker image prune -a
```

---

### 6.3 数据卷管理

```bash
# 查看数据卷
docker volume ls

# 查看数据卷详情
docker volume inspect <volume_name>

# 删除数据卷
docker volume rm <volume_name>

# 删除所有未使用的数据卷
docker volume prune
```

---

### 6.4 网络管理

```bash
# 查看网络
docker network ls

# 查看网络详情
docker network inspect <network_name>

# 删除网络
docker network rm <network_name>
```

---

## 七、数据备份与恢复

### 7.1 MySQL 备份

```bash
# 备份 MySQL 数据
docker exec mall_mysql_master mysqldump -u root -p${MYSQL_ROOT_PASSWORD} \
  mall_prod_db > backup_$(date +%Y%m%d_%H%M%S).sql

# 从备份恢复
docker exec -i mall_mysql_master mysql -u root -p${MYSQL_ROOT_PASSWORD} \
  mall_prod_db < backup_20240120_120000.sql
```

---

### 7.2 Redis 备份

```bash
# 备份 Redis 数据
docker exec mall_redis_master redis-cli --rdb /data/backup.rdb

# 复制备份文件
docker cp mall_redis_master:/data/dump.rdb ./redis_backup.rdb
```

---

### 7.3 自动备份脚本

```bash
#!/bin/bash
# scripts/backup.sh

BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p ${BACKUP_DIR}

# 备份 MySQL
docker exec mall_mysql_master mysqldump -u root -p${MYSQL_ROOT_PASSWORD} \
  mall_prod_db > ${BACKUP_DIR}/mysql_${DATE}.sql

# 备份 Redis
docker cp mall_redis_master:/data/dump.rdb ${BACKUP_DIR}/redis_${DATE}.rdb

# 删除 30 天前的备份
find ${BACKUP_DIR} -type f -mtime +30 -delete

echo "备份完成: ${DATE}"
```

---

## 八、监控与日志

### 8.1 查看服务日志

```bash
# 查看所有服务日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs -f backend
docker-compose logs -f nginx

# 查看最近 100 行日志
docker-compose --tail=100 logs backend
```

---

### 8.2 配置日志驱动

```yaml
# docker-compose.yml
services:
  backend:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

---

### 8.3 使用 ELK 收集日志

```yaml
# 添加到 docker-compose.yml
elasticsearch:
  image: elasticsearch:7.17.0
  environment:
    - discovery.type=single-node
  ports:
    - "9200:9200"
  volumes:
    - es_data:/usr/share/elasticsearch/data

logstash:
  image: logstash:7.17.0
  volumes:
    - ./logstash/pipeline:/usr/share/logstash/pipeline
  depends_on:
    - elasticsearch

kibana:
  image: kibana:7.17.0
  ports:
    - "5601:5601"
  depends_on:
    - elasticsearch
```

---

## 九、性能优化

### 9.1 资源限制

```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
```

---

### 9.2 健康检查

```yaml
services:
  backend:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

---

## 十、故障排查

### 10.1 常见问题

#### Q: 容器无法启动
```bash
# 查看容器日志
docker logs <container_name>

# 检查端口占用
netstat -tuln | grep <port>

# 检查磁盘空间
df -h
```

#### Q: 数据库连接失败
```bash
# 检查 MySQL 是否启动
docker exec mall_mysql mysqladmin ping -u root -p

# 检查网络连接
docker exec backend ping mysql
```

#### Q: 内存不足
```bash
# 查看容器资源使用
docker stats

# 清理未使用的资源
docker system prune -a
```

---

## 十一、安全加固

### 11.1 使用非 root 用户

```dockerfile
# Dockerfile
RUN useradd -m -u 1000 appuser
USER appuser
```

---

### 11.2 最小化镜像

```dockerfile
# 使用多阶段构建
FROM python:3.10-slim as builder
RUN pip install -r requirements.txt

FROM python:3.10-slim
COPY --from=builder /usr/local/lib/python3.10/site-packages /usr/local/lib/python3.10/site-packages
```

---

### 11.3 扫描漏洞

```bash
# 使用 Trivy 扫描镜像
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image mall_backend:latest
```

---

## 十二、检查清单

- [ ] Docker 已安装
- [ ] Docker Compose 已安装
- [ ] .env 文件已配置
- [ ] SSL 证书已配置（生产环境）
- [ ] 域名已解析
- [ ] 防火墙规则已配置
- [ ] 数据库备份策略已配置
- [ ] 日志收集已配置
- [ ] 监控告警已配置
- [ ] 健康检查已配置

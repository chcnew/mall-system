# 1.3 环境配置指南

## 一、环境要求

### 1.1 系统要求
- **操作系统**：Windows 10+ / macOS 10.15+ / Linux
- **Python**：3.10 或更高版本
- **Node.js**：16.0 或更高版本（用于后台管理）
- **MySQL**：8.0 或更高版本
- **Redis**：6.0 或更高版本

### 1.2 开发工具
- **代码编辑器**：VS Code / PyCharm
- **微信开发者工具**：最新版本
- **Git**：最新版本
- **Docker**：20.10+（可选）

---

## 二、后端环境配置

### 2.1 Python 环境搭建

#### 安装 Python
```bash
# macOS (使用 Homebrew)
brew install python@3.10

# Linux (Ubuntu/Debian)
sudo apt-get update
sudo apt-get install python3.10 python3.10-venv

# Windows
# 下载安装包：https://www.python.org/downloads/
```

#### 创建虚拟环境
```bash
# 进入后端目录
cd backend

# 创建虚拟环境
python -m venv venv

# 激活虚拟环境

# macOS / Linux
source venv/bin/activate

# Windows
venv\Scripts\activate
```

#### 验证 Python 环境
```bash
python --version  # 应显示 Python 3.10.x
```

---

### 2.2 依赖安装

#### 创建 requirements.txt
```txt
# Web 框架
fastapi==0.109.0
uvicorn[standard]==0.27.0
python-multipart==0.0.6

# 数据库
sqlalchemy==2.0.25
alembic==1.13.1
pymysql==1.1.0

# 缓存
redis==5.0.1

# 认证与安全
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
pydantic==2.5.3
pydantic-settings==2.1.0

# 异步任务
celery==5.3.6
redis==5.0.1

# HTTP 客户端
httpx==0.26.0

# 微信支付
wechatpayv3==1.2.35

# 日志
python-json-logger==2.0.7

# 开发工具
pytest==7.4.4
pytest-asyncio==0.23.3
```

#### 安装依赖
```bash
pip install -r requirements.txt
```

---

### 2.3 环境变量配置

#### 创建 .env 文件
复制 `.env.example` 到 `.env` 并填写配置：

```bash
cp .env.example .env
```

#### .env 配置说明

```bash
# ===== 应用配置 =====
PROJECT_NAME=微信商城小程序系统
VERSION=1.0.0
API_V1_STR=/api/v1
DEBUG=True

# ===== 数据库配置 =====
# 格式：mysql+pymysql://用户名:密码@主机:端口/数据库名
DATABASE_URL=mysql+pymysql://root:password@localhost:3306/mall_db

# ===== Redis 配置 =====
# 格式：redis://主机:端口/数据库
REDIS_URL=redis://localhost:6379/0
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# ===== JWT 配置 =====
SECRET_KEY=your-secret-key-change-this-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080  # 7天

# ===== 微信小程序配置 =====
# 在微信公众平台（https://mp.weixin.qq.com/）获取
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret

# ===== 微信支付配置 =====
# 在微信支付商户平台（https://pay.weixin.qq.com/）获取
WECHAT_MCH_ID=your_mch_id
WECHAT_API_V3_KEY=your_api_v3_key
# 证书路径（绝对路径或相对路径）
WECHAT_CERT_PATH=./certs/apiclient_cert.pem
WECHAT_KEY_PATH=./certs/apiclient_key.pem
# 支付回调地址（需要是公网可访问的 HTTPS 地址）
WECHAT_NOTIFY_URL=https://your-domain.com/api/v1/payment/notify

# ===== OSS 对象存储配置 =====
# 如使用阿里云 OSS
OSS_ACCESS_KEY_ID=your_oss_access_key_id
OSS_ACCESS_KEY_SECRET=your_oss_access_key_secret
OSS_BUCKET_NAME=your_bucket_name
OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com

# ===== CORS 配置 =====
# 允许访问的域名列表，逗号分隔
ALLOWED_HOSTS=http://localhost:5173,http://127.0.0.1:5173

# ===== 短信配置（预留） =====
SMS_ACCESS_KEY_ID=
SMS_ACCESS_KEY_SECRET=
SMS_SIGN_NAME=
SMS_TEMPLATE_CODE=

# ===== 日志配置 =====
LOG_LEVEL=INFO
LOG_DIR=logs
```

---

### 2.4 数据库准备

#### 创建数据库
```sql
-- 连接 MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE mall_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选）
CREATE USER 'mall_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON mall_db.* TO 'mall_user'@'localhost';
FLUSH PRIVILEGES;

-- 退出
EXIT;
```

---

### 2.5 数据库迁移

#### 初始化 Alembic
```bash
# 首次使用需要初始化
alembic init alembic
```

#### 配置 alembic.ini
```ini
# 修改数据库连接
sqlalchemy.url = mysql+pymysql://root:password@localhost:3306/mall_db
```

#### 配置 alembic/env.py
```python
from logging.config import fileConfig
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from alembic import context
from app.db.base import Base
from app.core.config import settings

# 导入所有模型（确保模型被注册）
from app.models import user, product, order, marketing, cart, system

config = context.config
config.set_main_option("sqlalchemy.url", settings.DATABASE_URL)
target_metadata = Base.metadata
```

#### 生成迁移文件
```bash
# 生成迁移脚本
alembic revision --autogenerate -m "Initial migration"
```

#### 执行迁移
```bash
# 升级到最新版本
alembic upgrade head

# 查看当前版本
alembic current

# 回滚一个版本
alembic downgrade -1
```

---

### 2.6 Redis 准备

#### 使用 Docker 启动 Redis
```bash
docker run -d -p 6379:6379 --name redis redis:7-alpine
```

#### 或使用本地安装
```bash
# macOS
brew install redis
brew services start redis

# Linux (Ubuntu/Debian)
sudo apt-get install redis-server
sudo systemctl start redis

# Windows
# 下载 Redis for Windows：https://github.com/microsoftarchive/redis/releases
```

#### 验证 Redis
```bash
redis-cli ping
# 应返回：PONG
```

---

### 2.7 启动后端服务

#### 开发模式启动
```bash
# 方式一：使用 uvicorn
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# 方式二：使用 python
python -m app.main

# 方式三：使用 Docker
docker-compose up backend
```

#### 验证服务启动
```bash
# 访问 API 文档
open http://localhost:8000/docs

# 或使用 curl
curl http://localhost:8000/
```

#### API 文档地址
- Swagger UI：http://localhost:8000/docs
- ReDoc：http://localhost:8000/redoc

---

### 2.8 Celery 配置（可选）

#### 启动 Celery Worker
```bash
# 启动 Worker
celery -A app.tasks.celery_app worker --loglevel=info

# 启动 Flower（监控）
celery -A app.tasks.celery_app flower
```

#### 配置 Celery（tasks/celery_app.py）
```python
from celery import Celery
from app.core.config import settings

celery_app = Celery(
    "mall_system",
    broker=settings.REDIS_URL,
    backend=settings.REDIS_URL
)

celery_app.conf.update(
    task_serializer="json",
    accept_content=["json"],
    result_serializer="json",
    timezone="Asia/Shanghai",
    enable_utc=True,
)
```

---

## 三、小程序环境配置

### 3.1 微信开发者工具

#### 安装微信开发者工具
- 下载地址：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html

#### 创建项目
1. 打开微信开发者工具
2. 选择"小程序"
3. 填写项目信息：
   - **项目名称**：微信商城小程序
   - **目录**：选择 `miniprogram` 目录
   - **AppID**：填写测试号或正式 AppID
   - **开发模式**：小程序

#### 配置 project.config.json
```json
{
  "appid": "your_appid",
  "projectname": "微信商城小程序",
  "description": "微信商城小程序",
  "setting": {
    "urlCheck": false,
    "es6": true,
    "postcss": true,
    "minified": true,
    "enhance": true
  },
  "compileType": "miniprogram"
}
```

---

### 3.2 小程序配置

#### app.json 配置
```json
{
  "pages": [
    "pages/index/index",
    "pages/category/index",
    "pages/cart/index",
    "pages/user/index",
    "pages/product/index",
    "pages/order/confirm/index",
    "pages/order/list/index",
    "pages/order/detail/index"
  ],
  "window": {
    "navigationBarTitleText": "微信商城",
    "navigationBarBackgroundColor": "#1890ff",
    "navigationBarTextStyle": "white",
    "backgroundColor": "#f5f5f5"
  },
  "tabBar": {
    "color": "#999999",
    "selectedColor": "#1890ff",
    "backgroundColor": "#ffffff",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "首页",
        "iconPath": "images/tabbar/home.png",
        "selectedIconPath": "images/tabbar/home-active.png"
      },
      {
        "pagePath": "pages/category/index",
        "text": "分类",
        "iconPath": "images/tabbar/category.png",
        "selectedIconPath": "images/tabbar/category-active.png"
      },
      {
        "pagePath": "pages/cart/index",
        "text": "购物车",
        "iconPath": "images/tabbar/cart.png",
        "selectedIconPath": "images/tabbar/cart-active.png"
      },
      {
        "pagePath": "pages/user/index",
        "text": "我的",
        "iconPath": "images/tabbar/user.png",
        "selectedIconPath": "images/tabbar/user-active.png"
      }
    ]
  },
  "sitemapLocation": "sitemap.json",
  "lazyCodeLoading": "requiredComponents"
}
```

#### 配置 config.js
```javascript
// 配置 API 地址
const config = {
  // 开发环境
  API_BASE_URL: 'http://localhost:8000/api/v1',

  // 生产环境
  // API_BASE_URL: 'https://your-domain.com/api/v1',

  // 上传接口
  UPLOAD_URL: 'http://localhost:8000/api/v1/upload',

  // 图片 CDN 域名（如果有）
  IMG_CDN_URL: ''
}

module.exports = config
```

#### 配置服务器域名（生产环境）
需要在微信公众平台配置：
- **request 合法域名**：https://your-domain.com
- **uploadFile 合法域名**：https://your-domain.com
- **downloadFile 合法域名**：https://your-domain.com

---

### 3.3 获取微信配置

#### 获取 AppID 和 AppSecret
1. 登录微信公众平台：https://mp.weixin.qq.com/
2. 进入"开发" → "开发管理" → "开发设置"
3. 记录 **AppID** 和 **AppSecret**
4. 将 AppID 填入 `.env` 文件的 `WECHAT_APP_ID`
5. 将 AppSecret 填入 `.env` 文件的 `WECHAT_APP_SECRET`

#### 配置服务器域名
1. 进入"开发" → "开发管理" → "开发设置" → "服务器域名"
2. 添加以下域名：
   - request 合法域名：`https://your-domain.com`
   - uploadFile 合法域名：`https://your-domain.com`
   - downloadFile 合法域名：`https://your-domain.com`

#### 注意事项
- 开发环境可以在微信开发者工具中关闭域名校验
- 生产环境必须配置合法域名且使用 HTTPS
- 域名需要完成 ICP 备案

---

## 四、后台管理环境配置

### 4.1 Node.js 环境

#### 安装 Node.js
```bash
# macOS (使用 Homebrew)
brew install node

# Linux (Ubuntu/Debian)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# Windows
# 下载安装包：https://nodejs.org/
```

#### 验证 Node.js
```bash
node --version  # 应显示 v18.x.x
npm --version    # 应显示 9.x.x
```

---

### 4.2 依赖安装

#### 创建 package.json
```json
{
  "name": "mall-admin",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vue-tsc && vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext .vue,.js,.jsx,.cjs,.mjs,.ts,.tsx,.cts,.mts --fix --ignore-path .gitignore"
  },
  "dependencies": {
    "vue": "^3.4.0",
    "vue-router": "^4.2.5",
    "pinia": "^2.1.7",
    "element-plus": "^2.5.0",
    "axios": "^1.6.5",
    "echarts": "^5.4.3",
    "@vueuse/core": "^10.7.0"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^5.0.0",
    "vite": "^5.0.10",
    "typescript": "^5.3.3",
    "vue-tsc": "^1.8.27",
    "sass": "^1.69.5"
  }
}
```

#### 安装依赖
```bash
cd admin
npm install
```

---

### 4.3 配置文件

#### vite.config.ts
```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import path from 'path'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src')
    }
  },
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  }
})
```

#### tsconfig.json
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "preserve",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*.ts", "src/**/*.d.ts", "src/**/*.tsx", "src/**/*.vue"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

---

### 4.4 启动开发服务器

```bash
# 开发模式
npm run dev

# 访问 http://localhost:5173
```

---

## 五、Docker 环境配置

### 5.1 安装 Docker

#### macOS / Windows
- 下载 Docker Desktop：https://www.docker.com/products/docker-desktop

#### Linux
```bash
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh
```

---

### 5.2 Docker Compose 配置

#### docker-compose.yml
```yaml
version: '3.8'

services:
  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: mall_mysql
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: mall_db
      MYSQL_USER: mall_user
      MYSQL_PASSWORD: mall_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - mall_network

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: mall_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - mall_network

  # 后端服务
  backend:
    build: ./backend
    container_name: mall_backend
    environment:
      - DATABASE_URL=mysql+pymysql://mall_user:mall_password@mysql:3306/mall_db
      - REDIS_URL=redis://redis:6379/0
    ports:
      - "8000:8000"
    depends_on:
      - mysql
      - redis
    volumes:
      - ./backend:/app
      - ./logs:/app/logs
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    networks:
      - mall_network

  # Celery Worker
  celery_worker:
    build: ./backend
    container_name: mall_celery_worker
    environment:
      - DATABASE_URL=mysql+pymysql://mall_user:mall_password@mysql:3306/mall_db
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - mysql
      - redis
    command: celery -A app.tasks.celery_app worker --loglevel=info
    networks:
      - mall_network

volumes:
  mysql_data:
  redis_data:

networks:
  mall_network:
    driver: bridge
```

---

### 5.3 Docker 启动

```bash
# 启动所有服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 停止并删除数据卷
docker-compose down -v
```

---

## 六、常见问题

### 6.1 后端问题

#### Q: 数据库连接失败
A:
1. 检查 MySQL 是否启动
2. 检查 `.env` 中的数据库配置是否正确
3. 检查数据库用户权限
4. 检查防火墙设置

#### Q: Redis 连接失败
A:
1. 检查 Redis 是否启动：`redis-cli ping`
2. 检查 `.env` 中的 Redis 配置是否正确
3. 检查 Redis 密码是否正确

#### Q: Alembic 迁移失败
A:
1. 检查 alembic.ini 中的数据库连接是否正确
2. 检查 models 是否正确导入
3. 尝试删除 alembic/versions 下的所有文件，重新生成迁移

---

### 6.2 小程序问题

#### Q: 网络请求失败
A:
1. 开发环境：检查是否关闭域名校验
2. 生产环境：检查是否配置了合法域名
3. 检查后端服务是否启动

#### Q: 登录失败
A:
1. 检查 `.env` 中的微信 AppID 和 AppSecret 是否正确
2. 检查后端日志查看详细错误信息
3. 确认用户是否已授权

---

### 6.3 后台管理问题

#### Q: 代理失效
A:
1. 检查 vite.config.ts 中的 proxy 配置
2. 确认后端服务已启动
3. 检查端口是否被占用

---

## 七、生产环境配置

### 7.1 安全配置

#### 修改 SECRET_KEY
```bash
# 生成随机密钥
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

#### 关闭 DEBUG 模式
```bash
DEBUG=False
```

#### 配置 HTTPS
1. 申请 SSL 证书
2. 配置 Nginx 使用 SSL
3. 将所有 HTTP 请求重定向到 HTTPS

---

### 7.2 性能配置

#### 数据库连接池
```python
# 在 app/db/session.py 中
engine = create_engine(
    settings.DATABASE_URL,
    pool_size=20,        # 连接池大小
    max_overflow=40,     # 最大溢出连接数
    pool_pre_ping=True,  # 连接前检测
    pool_recycle=3600    # 连接回收时间（秒）
)
```

#### Redis 连接池
```python
# 在 app/db/redis_client.py 中
redis_client = redis.Redis(
    host=settings.REDIS_HOST,
    port=settings.REDIS_PORT,
    db=settings.REDIS_DB,
    max_connections=50,  # 最大连接数
    decode_responses=True
)
```

---

### 7.3 日志配置

#### 生产环境日志级别
```bash
LOG_LEVEL=WARNING
```

#### 配置日志轮转
```python
import logging.handlers

# 按日期轮转
handler = logging.handlers.TimedRotatingFileHandler(
    'logs/app.log',
    when='midnight',
    interval=1,
    backupCount=30
)
```

---

## 八、检查清单

### 8.1 后端环境检查

- [ ] Python 3.10+ 已安装
- [ ] 虚拟环境已创建并激活
- [ ] 所有依赖已安装
- [ ] .env 文件已配置
- [ ] MySQL 数据库已创建
- [ ] 数据库迁移已执行
- [ ] Redis 已启动
- [ ] 后端服务可访问

### 8.2 小程序环境检查

- [ ] 微信开发者工具已安装
- [ ] AppID 已配置
- [ ] API 地址已配置
- [ ] 服务器域名已配置（生产环境）
- [ ] 可正常预览小程序

### 8.3 后台管理环境检查

- [ ] Node.js 已安装
- [ ] 依赖已安装
- [ ] 开发服务器可启动
- [ ] 可正常访问管理后台

### 8.4 Docker 环境检查（可选）

- [ ] Docker 已安装
- [ ] docker-compose.yml 已配置
- [ ] 所有容器可正常启动
- [ ] 服务间网络通信正常

---

## 九、快速启动指南

### 方式一：本地开发

```bash
# 1. 启动 MySQL 和 Redis（使用 Docker）
docker-compose up -d mysql redis

# 2. 启动后端
cd backend
source venv/bin/activate
uvicorn app.main:app --reload

# 3. 启动小程序
# 使用微信开发者工具打开 miniprogram 目录

# 4. 启动后台管理
cd admin
npm run dev
```

### 方式二：Docker 一键启动

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

---

## 十、参考链接

- FastAPI 文档：https://fastapi.tiangolo.com/
- SQLAlchemy 文档：https://docs.sqlalchemy.org/
- Alembic 文档：https://alembic.sqlalchemy.org/
- 微信小程序文档：https://developers.weixin.qq.com/miniprogram/dev/framework/
- Vue 3 文档：https://vuejs.org/
- Element Plus 文档：https://element-plus.org/
- Vite 文档：https://vitejs.dev/
- Docker 文档：https://docs.docker.com/

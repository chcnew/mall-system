# 1.2 数据库设计

## 一、数据库概述

### 1.1 技术选型
- **数据库**：MySQL 8.0+
- **ORM 框架**：SQLAlchemy 2.0
- **迁移工具**：Alembic

### 1.2 命名规范
- 表名：小写，下划线分隔（如：`user_addresses`）
- 字段名：小写，下划线分隔
- 主键：统一使用 `id` (BIGINT, AUTO_INCREMENT)
- 时间戳：`created_at` (创建时间), `updated_at` (更新时间)
- 状态字段：统一使用 `status` (TINYINT)

### 1.3 字段类型
- 主键/外键：`BIGINT`
- 金额：`DECIMAL(10,2)`
- 文本：`TEXT` / `VARCHAR`
- JSON 数据：`JSON` 类型（MySQL 5.7+）
- 时间：`DATETIME`
- 布尔/状态：`TINYINT` (0/1)

---

## 二、ER 图

```
┌─────────────┐         ┌──────────────┐
│   users     │         │   orders     │
├─────────────┤         ├──────────────┤
│ id (PK)     │◄────────┤ id (PK)      │
│ openid      │         │ order_no     │
│ unionid     │         │ user_id (FK) │
│ nickname    │         │ total_amount │
│ avatar      │         │ status       │
│ ...         │         └──────────────┘
└─────────────┘                  │
        │                        │
        │                        │
        ▼                        ▼
┌──────────────────┐    ┌─────────────────┐
│ user_addresses  │    │  order_items    │
├──────────────────┤    ├─────────────────┤
│ id (PK)          │    │ id (PK)         │
│ user_id (FK)     │    │ order_id (FK)   │
│ name             │    │ product_id (FK) │
│ phone            │    │ sku_id (FK)     │
│ province         │    │ price           │
│ city             │    │ quantity        │
│ district         │    └─────────────────┘
│ detail           │
│ is_default       │
└──────────────────┘

┌─────────────┐         ┌──────────────┐
│ categories  │         │   products   │
├─────────────┤         ├──────────────┤
│ id (PK)     │         │ id (PK)      │
│ parent_id   │◄────────┤ category_id  │
│ name        │         │ name         │
│ icon        │         │ price        │
│ sort        │         │ stock        │
│ status      │         │ status       │
└─────────────┘         └──────────────┘
                               │
                               │
                               ▼
                     ┌─────────────────┐
                     │ product_skus    │
                     ├─────────────────┤
                     │ id (PK)         │
                     │ product_id (FK) │
                     │ sku_code        │
                     │ specs (JSON)    │
                     │ price           │
                     │ stock           │
                     └─────────────────┘

┌──────────────────┐         ┌──────────────────┐
│ coupon_templates │         │  user_coupons    │
├──────────────────┤         ├──────────────────┤
│ id (PK)          │◄────────┤ id (PK)          │
│ name             │         │ user_id (FK)     │
│ type             │         │ coupon_id (FK)   │
│ value            │         │ status           │
│ min_amount       │         │ used_time        │
│ total_count      │         │ expire_time      │
│ remain_count     │         └──────────────────┘
│ per_limit        │
│ start_time       │
│ end_time         │
└──────────────────┘

┌──────────────────┐    ┌─────────────────┐
│     carts        │    │    banners      │
├──────────────────┤    ├─────────────────┤
│ id (PK)          │    │ id (PK)         │
│ user_id (FK)     │    │ title           │
│ product_id (FK)  │    │ image           │
│ sku_id (FK)      │    │ link_type       │
│ quantity         │    │ link_value      │
│ selected         │    │ sort            │
└──────────────────┘    │ status          │
                         └─────────────────┘

┌──────────────────┐    ┌──────────────────┐
│      admins      │    │  system_configs  │
├──────────────────┤    ├──────────────────┤
│ id (PK)          │    │ id (PK)          │
│ username         │    │ config_key       │
│ password         │    │ config_value     │
│ nickname         │    │ remark           │
│ role             │    └──────────────────┘
│ status           │
└──────────────────┘
```

---

## 三、表结构详细设计

### 3.1 用户模块

#### users（用户表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| openid | VARCHAR | 64 | NO | - | 微信 openid，唯一 |
| unionid | VARCHAR | 64 | YES | - | 微信 unionid |
| nickname | VARCHAR | 64 | YES | - | 昵称 |
| avatar | VARCHAR | 255 | YES | - | 头像 URL |
| phone | VARCHAR | 20 | YES | - | 手机号 |
| gender | TINYINT | - | NO | 0 | 性别：0未知 1男 2女 |
| balance | DECIMAL | 10,2 | NO | 0.00 | 余额 |
| points | INT | - | NO | 0 | 积分 |
| status | TINYINT | - | NO | 1 | 状态：0禁用 1正常 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引：**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_openid` (`openid`)
- INDEX: `idx_phone` (`phone`)
- INDEX: `idx_status` (`status`)

**说明：**
- `openid` 用于用户唯一标识
- `unionid` 可用于跨应用用户打通
- `balance` 和 `points` 保留用于未来扩展

#### user_addresses（收货地址表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| user_id | BIGINT | - | NO | - | 用户 ID，外键 |
| name | VARCHAR | 32 | NO | - | 收货人 |
| phone | VARCHAR | 20 | NO | - | 联系电话 |
| province | VARCHAR | 32 | NO | - | 省 |
| city | VARCHAR | 32 | NO | - | 市 |
| district | VARCHAR | 32 | NO | - | 区 |
| detail | VARCHAR | 255 | NO | - | 详细地址 |
| is_default | TINYINT | - | NO | 0 | 是否默认地址 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY: `id`
- INDEX: `idx_user_id` (`user_id`)

**外键：**
- FOREIGN KEY: `user_id` → `users(id)`

---

### 3.2 商品模块

#### categories（商品分类表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| parent_id | BIGINT | - | NO | 0 | 父分类 ID，0 表示顶级 |
| name | VARCHAR | 64 | NO | - | 分类名称 |
| icon | VARCHAR | 255 | YES | - | 分类图标 URL |
| sort | INT | - | NO | 0 | 排序，值越小越靠前 |
| status | TINYINT | - | NO | 1 | 状态：0禁用 1启用 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY: `id`
- INDEX: `idx_parent_id` (`parent_id`)
- INDEX: `idx_status` (`status`)

**说明：**
- 支持多级分类
- `parent_id = 0` 表示顶级分类

#### products（商品表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| category_id | BIGINT | - | NO | - | 分类 ID，外键 |
| name | VARCHAR | 128 | NO | - | 商品名称 |
| subtitle | VARCHAR | 255 | YES | - | 副标题/简短描述 |
| cover | VARCHAR | 255 | YES | - | 封面图 URL |
| images | JSON | - | YES | - | 商品图片数组 |
| description | TEXT | - | YES | - | 商品描述（富文本） |
| price | DECIMAL | 10,2 | NO | - | 销售价（SKU 价格取最小值） |
| original_price | DECIMAL | 10,2 | YES | - | 原价 |
| stock | INT | - | NO | 0 | 总库存（SKU 库存之和） |
| sales | INT | - | NO | 0 | 销量 |
| status | TINYINT | - | NO | 1 | 状态：0下架 1上架 |
| is_hot | TINYINT | - | NO | 0 | 是否热门 |
| is_new | TINYINT | - | NO | 0 | 是否新品 |
| sort | INT | - | NO | 0 | 排序 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引：**
- PRIMARY KEY: `id`
- INDEX: `idx_category_id` (`category_id`)
- INDEX: `idx_status` (`status`)
- INDEX: `idx_is_hot` (`is_hot`)
- INDEX: `idx_is_new` (`is_new`)
- INDEX: `idx_sales` (`sales`)
- INDEX: `idx_sort` (`sort`)

**外键：**
- FOREIGN KEY: `category_id` → `categories(id)`

#### product_skus（商品 SKU 表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| product_id | BIGINT | - | NO | - | 商品 ID，外键 |
| sku_code | VARCHAR | 64 | YES | - | SKU 编码 |
| specs | JSON | - | YES | - | 规格，如：{"颜色":"红色","尺寸":"XL"} |
| price | DECIMAL | 10,2 | NO | - | SKU 价格 |
| stock | INT | - | NO | 0 | SKU 库存 |
| image | VARCHAR | 255 | YES | - | SKU 图片（可选） |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_sku_code` (`sku_code`)
- INDEX: `idx_product_id` (`product_id`)

**外键：**
- FOREIGN KEY: `product_id` → `products(id)`

**说明：**
- `specs` 存储规格键值对，支持多维度规格
- 如无规格，可只创建一个默认 SKU

---

### 3.3 订单模块

#### orders（订单表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| order_no | VARCHAR | 32 | - | NO | - | 订单号，唯一 |
| user_id | BIGINT | - | NO | - | 用户 ID，外键 |
| total_amount | DECIMAL | 10,2 | NO | - | 订单总额（商品总价） |
| pay_amount | DECIMAL | 10,2 | NO | - | 实付金额 |
| freight_amount | DECIMAL | 10,2 | NO | 0.00 | 运费 |
| discount_amount | DECIMAL | 10,2 | NO | 0.00 | 优惠金额 |
| coupon_id | BIGINT | - | YES | - | 优惠券 ID |
| status | TINYINT | - | NO | 0 | 状态：0待付款 1待发货 2待收货 3已完成 4已取消 5已退款 |
| pay_time | DATETIME | - | YES | - | 支付时间 |
| pay_type | TINYINT | - | YES | - | 支付方式：1微信支付 |
| transaction_id | VARCHAR | 64 | YES | - | 微信支付流水号 |
| ship_time | DATETIME | - | YES | - | 发货时间 |
| receive_time | DATETIME | - | YES | - | 收货时间 |
| address_snapshot | JSON | - | YES | - | 收货地址快照 |
| remark | VARCHAR | 255 | YES | - | 订单备注 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引：**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_order_no` (`order_no`)
- INDEX: `idx_user_id` (`user_id`)
- INDEX: `idx_status` (`status`)
- INDEX: `idx_created_at` (`created_at`)
- INDEX: `idx_pay_time` (`pay_time`)
- INDEX: `idx_coupon_id` (`coupon_id`)

**外键：**
- FOREIGN KEY: `user_id` → `users(id)`

**状态流转：**
```
0 (待付款) ──支付──> 1 (待发货) ──发货──> 2 (待收货) ──收货──> 3 (已完成)
    │                           │                    │
    └──取消/超时──> 4 (已取消)  └──退款──> 5 (已退款) └──退款──> 5 (已退款)
```

#### order_items（订单商品表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| order_id | BIGINT | - | NO | - | 订单 ID，外键 |
| product_id | BIGINT | - | NO | - | 商品 ID，外键 |
| sku_id | BIGINT | - | YES | - | SKU ID，外键 |
| product_name | VARCHAR | 128 | NO | - | 商品名称（快照） |
| product_image | VARCHAR | 255 | YES | - | 商品图片（快照） |
| specs | VARCHAR | 255 | YES | - | 规格（快照） |
| price | DECIMAL | 10,2 | NO | - | 单价（快照） |
| quantity | INT | - | NO | - | 数量 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY: `id`
- INDEX: `idx_order_id` (`order_id`)
- INDEX: `idx_product_id` (`product_id`)
- INDEX: `idx_sku_id` (`sku_id`)

**外键：**
- FOREIGN KEY: `order_id` → `orders(id)`
- FOREIGN KEY: `product_id` → `products(id)`
- FOREIGN KEY: `sku_id` → `product_skus(id)`

**说明：**
- 商品信息使用快照，防止商品修改影响历史订单

#### order_logistics（物流信息表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| order_id | BIGINT | - | NO | - | 订单 ID，外键 |
| company | VARCHAR | 32 | YES | - | 物流公司 |
| tracking_no | VARCHAR | 64 | YES | - | 物流单号 |
| traces | JSON | - | YES | - | 物流轨迹 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引：**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_order_id` (`order_id`)

**外键：**
- FOREIGN KEY: `order_id` → `orders(id)`

**traces 数据结构示例：**
```json
[
  {"time": "2024-01-20 10:00:00", "status": "已揽收", "location": "深圳市"},
  {"time": "2024-01-21 08:00:00", "status": "运输中", "location": "广州市"},
  {"time": "2024-01-22 15:00:00", "status": "派送中", "location": "北京市"},
  {"time": "2024-01-22 18:00:00", "status": "已签收", "location": "北京市"}
]
```

---

### 3.4 营销模块

#### coupon_templates（优惠券模板表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| name | VARCHAR | 64 | NO | - | 优惠券名称 |
| type | TINYINT | - | NO | - | 类型：1满减 2折扣 3无门槛 |
| value | DECIMAL | 10,2 | NO | - | 优惠值（满减金额/折扣值） |
| min_amount | DECIMAL | 10,2 | NO | 0 | 最低消费金额 |
| total_count | INT | - | NO | - | 发放总量 |
| remain_count | INT | - | NO | - | 剩余数量 |
| per_limit | INT | - | NO | 1 | 每人限领数量 |
| start_time | DATETIME | - | YES | - | 开始时间 |
| end_time | DATETIME | - | YES | - | 结束时间 |
| status | TINYINT | - | NO | 1 | 状态：0禁用 1启用 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY: `id`
- INDEX: `idx_status` (`status`)
- INDEX: `idx_start_end_time` (`start_time`, `end_time`)

#### user_coupons（用户优惠券表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| user_id | BIGINT | - | NO | - | 用户 ID，外键 |
| coupon_id | BIGINT | - | NO | - | 优惠券模板 ID，外键 |
| status | TINYINT | - | NO | 0 | 状态：0未使用 1已使用 2已过期 |
| used_time | DATETIME | - | YES | - | 使用时间 |
| order_id | BIGINT | - | YES | - | 使用订单 ID |
| expire_time | DATETIME | - | NO | - | 过期时间 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY: `id`
- INDEX: `idx_user_id` (`user_id`)
- INDEX: `idx_coupon_id` (`coupon_id`)
- INDEX: `idx_status` (`status`)
- INDEX: `idx_expire_time` (`expire_time`)

**外键：**
- FOREIGN KEY: `user_id` → `users(id)`
- FOREIGN KEY: `coupon_id` → `coupon_templates(id)`

---

### 3.5 购物车模块

#### carts（购物车表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| user_id | BIGINT | - | NO | - | 用户 ID，外键 |
| product_id | BIGINT | - | NO | - | 商品 ID，外键 |
| sku_id | BIGINT | - | YES | - | SKU ID，外键 |
| quantity | INT | - | NO | 1 | 数量 |
| selected | TINYINT | - | NO | 1 | 是否选中：0否 1是 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | NO | CURRENT_TIMESTAMP ON UPDATE | 更新时间 |

**索引：**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_user_sku` (`user_id`, `product_id`, `sku_id`)
- INDEX: `idx_user_id` (`user_id`)

**外键：**
- FOREIGN KEY: `user_id` → `users(id)`
- FOREIGN KEY: `product_id` → `products(id)`
- FOREIGN KEY: `sku_id` → `product_skus(id)`

---

### 3.6 系统模块

#### admins（后台管理员表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| username | VARCHAR | 32 | - | NO | - | 用户名，唯一 |
| password | VARCHAR | 128 | - | NO | - | 密码（哈希） |
| nickname | VARCHAR | 64 | YES | - | 昵称 |
| avatar | VARCHAR | 255 | YES | - | 头像 URL |
| role | VARCHAR | 32 | NO | admin | 角色 |
| status | TINYINT | - | NO | 1 | 状态：0禁用 1启用 |
| last_login | DATETIME | - | YES | - | 最后登录时间 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_username` (`username`)
- INDEX: `idx_status` (`status`)

#### system_configs（系统配置表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| config_key | VARCHAR | 64 | - | NO | - | 配置键，唯一 |
| config_value | TEXT | - | YES | - | 配置值 |
| remark | VARCHAR | 255 | YES | - | 说明 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY: `id`
- UNIQUE KEY: `uk_config_key` (`config_key`)

**常见配置项：**
- `mall_name`: 商城名称
- `customer_service_phone`: 客服电话
- `freight_amount`: 默认运费
- `freight_free_amount`: 免运费金额
- `order_cancel_minutes`: 订单自动取消时间（分钟）

#### banners（轮播图表）

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|----------|--------|------|
| id | BIGINT | - | NO | AUTO_INCREMENT | 主键 |
| title | VARCHAR | 64 | YES | - | 标题 |
| image | VARCHAR | 255 | NO | - | 图片 URL |
| link_type | TINYINT | - | YES | - | 链接类型：1商品 2分类 3页面 4外链 |
| link_value | VARCHAR | 255 | YES | - | 链接值 |
| sort | INT | - | NO | 0 | 排序 |
| status | TINYINT | - | NO | 1 | 状态：0禁用 1启用 |
| created_at | DATETIME | - | NO | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY: `id`
- INDEX: `idx_status` (`status`)
- INDEX: `idx_sort` (`sort`)

---

## 四、数据字典

### 4.1 状态码定义

#### 订单状态（order.status）
| 值 | 状态 | 说明 |
|----|------|------|
| 0 | 待付款 | 订单已创建，未支付 |
| 1 | 待发货 | 已支付，待发货 |
| 2 | 待收货 | 已发货，待用户确认 |
| 3 | 已完成 | 用户确认收货 |
| 4 | 已取消 | 订单取消（未支付或已退款） |
| 5 | 已退款 | 已退款 |

#### 优惠券类型（coupon_templates.type）
| 值 | 类型 | 说明 |
|----|------|------|
| 1 | 满减 | 满足金额减免固定金额 |
| 2 | 折扣 | 折扣优惠（如 0.9 表示9折） |
| 3 | 无门槛 | 直接减免 |

#### 用户优惠券状态（user_coupons.status）
| 值 | 状态 | 说明 |
|----|------|------|
| 0 | 未使用 | 已领取，可使用 |
| 1 | 已使用 | 已使用 |
| 2 | 已过期 | 已过期 |

#### 支付类型（order.pay_type）
| 值 | 类型 | 说明 |
|----|------|------|
| 1 | 微信支付 | 小程序微信支付 |

#### 链接类型（banner.link_type）
| 值 | 类型 | 说明 |
|----|------|------|
| 1 | 商品 | 跳转商品详情 |
| 2 | 分类 | 跳转分类页 |
| 3 | 页面 | 跳转指定页面 |
| 4 | 外链 | 外部链接 |

### 4.2 JSON 字段结构

#### products.images
```json
["https://example.com/image1.jpg", "https://example.com/image2.jpg"]
```

#### product_skus.specs
```json
{"颜色": "红色", "尺寸": "XL"}
```

#### orders.address_snapshot
```json
{
  "name": "张三",
  "phone": "13800138000",
  "province": "广东省",
  "city": "深圳市",
  "district": "南山区",
  "detail": "科技园123号"
}
```

---

## 五、索引策略

### 5.1 单列索引
- 高频查询字段（status、created_at）
- 外键字段

### 5.2 联合索引
- 订单查询：`idx_user_status` (`user_id`, `status`)
- 订单时间查询：`idx_user_created` (`user_id`, `created_at`)
- 优惠券查询：`idx_user_status_expire` (`user_id`, `status`, `expire_time`)

### 5.3 唯一索引
- 业务唯一字段（openid、order_no、sku_code）
- 购物车唯一组合（user_id + product_id + sku_id）

---

## 六、外键约束

所有外键关系：

| 子表 | 子表字段 | 父表 | 父表字段 | 级联策略 |
|------|---------|------|---------|---------|
| user_addresses | user_id | users | id | CASCADE |
| orders | user_id | users | id | CASCADE |
| user_coupons | user_id | users | id | CASCADE |
| carts | user_id | users | id | CASCADE |
| products | category_id | categories | id | RESTRICT |
| product_skus | product_id | products | id | CASCADE |
| order_items | order_id | orders | id | CASCADE |
| order_items | product_id | products | id | RESTRICT |
| order_items | sku_id | product_skus | id | RESTRICT |
| order_logistics | order_id | orders | id | CASCADE |
| user_coupons | coupon_id | coupon_templates | id | RESTRICT |

---

## 七、数据初始化

### 7.1 默认管理员
```sql
INSERT INTO admins (username, password, nickname, role, status)
VALUES ('admin', '$2b$12$...', '超级管理员', 'admin', 1);
```

### 7.2 默认系统配置
```sql
INSERT INTO system_configs (config_key, config_value, remark) VALUES
('mall_name', '微信商城', '商城名称'),
('customer_service_phone', '400-888-8888', '客服电话'),
('freight_amount', '10.00', '默认运费'),
('freight_free_amount', '99.00', '免运费金额'),
('order_cancel_minutes', '30', '订单自动取消时间');
```

---

## 八、数据库维护

### 8.1 备份策略
- 每日全量备份
- 保留 30 天备份
- 使用 mysqldump

### 8.2 慢查询优化
- 开启慢查询日志
- 定期分析慢查询
- 优化索引

### 8.3 数据清理
- 订单表：保留 2 年数据
- 日志表：保留 1 个月数据
- 定期归档历史数据

---

## 九、性能优化建议

### 9.1 查询优化
- 避免使用 SELECT *
- 合理使用 JOIN
- 使用索引覆盖查询

### 9.2 缓存策略
- 热点数据使用 Redis 缓存
- 商品详情：1 小时
- 分类列表：1 小时
- 用户信息：7 天

### 9.3 分页优化
- 使用游标分页（深分页场景）
- 限制单页最大数量

---

## 十、安全建议

### 10.1 敏感信息
- 密码哈希存储（bcrypt）
- Token 使用加密
- API 密钥使用环境变量

### 10.2 SQL 注入防护
- 使用 ORM 参数化查询
- 避免拼接 SQL

### 10.3 权限控制
- 应用层权限验证
- 数据库最小权限原则

---

## 总结

本数据库设计遵循以下原则：

1. **规范化设计**：合理的表结构和关系
2. **性能优化**：合理的索引和缓存策略
3. **可扩展性**：预留扩展字段（JSON 类型）
4. **数据一致性**：外键约束和事务支持
5. **安全性**：密码哈希、权限控制

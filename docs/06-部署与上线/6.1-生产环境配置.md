# 6.1 生产环境配置

## 一、服务器配置

### 1.1 服务器要求

**生产环境**（推荐配置）:
- CPU: 4 核
- 内存: 8G
- 硬盘: 100G SSD
- 带宽: 10Mbps
- 操作系统: Ubuntu 20.04 LTS / CentOS 7+

**测试环境**（最低配置）:
- CPU: 2 核
- 内存: 4G
- 硬盘: 50G SSD
- 带宽: 5Mbps

---

### 1.2 系统初始化

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装基础软件
sudo apt install -y curl wget vim git unzip

# 设置时区
sudo timedatectl set-timezone Asia/Shanghai

# 配置防火墙
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

---

## 二、Docker 环境

### 2.1 安装 Docker

```bash
# 安装 Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 启动 Docker
sudo systemctl start docker
sudo systemctl enable docker

# 配置镜像加速
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ]
}
EOF

sudo systemctl daemon-reload
sudo systemctl restart docker
```

---

### 2.2 安装 Docker Compose

```bash
# 下载 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 添加执行权限
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker-compose --version
```

---

## 三、MySQL 配置

### 3.1 生产环境配置

```ini
# mysql/my.cnf
[mysqld]
# 基础配置
port = 3306
default-storage-engine = InnoDB
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 连接配置
max_connections = 500
max_connect_errors = 100000
max_user_connections = 400

# InnoDB 配置
innodb_buffer_pool_size = 4G
innodb_log_file_size = 512M
innodb_log_buffer_size = 64M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# 查询缓存
query_cache_size = 0
query_cache_type = 0

# 慢查询
slow_query_log = 1
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 2

# 二进制日志
log_bin = /var/log/mysql/mysql-bin.log
binlog_format = ROW
expire_logs_days = 7

# 字符集
character_set_server = utf8mb4
collation_server = utf8mb4_unicode_ci
```

---

### 3.2 数据库备份配置

```bash
# 创建备份脚本
cat > /opt/scripts/backup_mysql.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/data/backup/mysql"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_USER="root"
MYSQL_PASSWORD="your_password"
DATABASE="mall_prod_db"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据
mysqldump -u$MYSQL_USER -p$MYSQL_PASSWORD $DATABASE > $BACKUP_DIR/mall_$DATE.sql

# 压缩备份
gzip $BACKUP_DIR/mall_$DATE.sql

# 删除 30 天前的备份
find $BACKUP_DIR -name "mall_*.sql.gz" -mtime +30 -delete

echo "Backup completed: $DATE"
EOF

# 添加执行权限
chmod +x /opt/scripts/backup_mysql.sh

# 添加定时任务（每天凌晨 2 点备份）
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/scripts/backup_mysql.sh >> /var/log/backup_mysql.log 2>&1") | crontab -
```

---

## 四、Redis 配置

### 4.1 生产环境配置

```ini
# redis/redis.conf
# 网络配置
bind 0.0.0.0
port 6379
protected-mode yes

# 持久化配置
save 900 1
save 300 10
save 60 10000
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec

# 内存配置
maxmemory 2gb
maxmemory-policy allkeys-lru

# 日志配置
loglevel notice
logfile /var/log/redis/redis.log

# 慢查询
slowlog-log-slower-than 10000
slowlog-max-len 128

# 密码配置
requirepass your_strong_redis_password
```

---

## 五、Nginx 配置

### 5.1 生产环境配置

```nginx
# nginx/nginx.conf
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # 性能优化
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;

    # API 反向代理
    server {
        listen 80;
        server_name api.mall.com;

        # HTTP 重定向到 HTTPS
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name api.mall.com;

        # SSL 证书
        ssl_certificate /etc/nginx/ssl/api.mall.com.crt;
        ssl_certificate_key /etc/nginx/ssl/api.mall.com.key;

        # SSL 配置
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # API 代理
        location / {
            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 60s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;
        }
    }

    # 后台管理前端
    server {
        listen 80;
        server_name admin.mall.com;

        # HTTP 重定向到 HTTPS
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name admin.mall.com;

        # SSL 证书
        ssl_certificate /etc/nginx/ssl/admin.mall.com.crt;
        ssl_certificate_key /etc/nginx/ssl/admin.mall.com.key;

        # SSL 配置
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # 前端静态文件
        root /usr/share/nginx/html;
        index index.html;

        # 前端路由
        location / {
            try_files $uri $uri/ /index.html;
        }

        # API 代理
        location /api {
            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 静态资源缓存
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

---

## 六、SSL 证书配置

### 6.1 Let's Encrypt 免费证书

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取证书（自动配置 Nginx）
sudo certbot --nginx -d api.mall.com -d admin.mall.com

# 测试自动续期
sudo certbot renew --dry-run

# 添加自动续期定时任务
echo "0 0,12 * * * root python -c 'import random; import time; time.sleep(random.random() * 3600)' && certbot renew -q" | sudo tee -a /etc/crontab
```

---

## 七、环境变量配置

### 7.1 生产环境变量

```bash
# .env.prod
# ===== 应用配置 =====
PROJECT_NAME=微信商城小程序系统
VERSION=1.0.0
DEBUG=False

# ===== 数据库配置 =====
MYSQL_ROOT_PASSWORD=your_strong_password
MYSQL_DATABASE=mall_prod_db
MYSQL_USER=mall_prod_user
MYSQL_PASSWORD=your_strong_password

# ===== Redis 配置 =====
REDIS_PASSWORD=your_strong_redis_password

# ===== JWT 配置 =====
SECRET_KEY=your_production_secret_key_at_least_32_characters_long
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080

# ===== 微信配置 =====
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_APP_SECRET=your_wechat_app_secret

# ===== 微信支付配置 =====
WECHAT_MCH_ID=1234567890
WECHAT_API_V3_KEY=your_api_v3_key_32_characters
WECHAT_CERT_PATH=/app/certs/apiclient_cert.pem
WECHAT_KEY_PATH=/app/certs/apiclient_key.pem
WECHAT_NOTIFY_URL=https://api.mall.com/api/v1/payment/notify

# ===== OSS 配置 =====
OSS_ACCESS_KEY_ID=your_oss_access_key_id
OSS_ACCESS_KEY_SECRET=your_oss_access_key_secret
OSS_BUCKET_NAME=your_bucket_name
OSS_ENDPOINT=https://oss-cn-hangzhou.aliyuncs.com

# ===== CORS 配置 =====
ALLOWED_HOSTS=https://api.mall.com,https://admin.mall.com
```

---

## 八、监控配置

### 8.1 日志收集

```yaml
# docker-compose.prod.yml
services:
  backend:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

---

### 8.2 系统监控

```bash
# 安装 htop
sudo apt install htop

# 安装 iotop
sudo apt install iotop

# 安装 nethogs（网络监控）
sudo apt install nethogs
```

---

## 九、安全加固

### 9.1 系统安全

```bash
# 禁用 root 登录
sudo sed -i 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config

# 禁用密码登录，使用密钥登录
sudo sed -i 's/PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# 重启 SSH 服务
sudo systemctl restart sshd

# 配置 fail2ban 防暴力破解
sudo apt install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

---

### 9.2 防火墙规则

```bash
# 允许 SSH
sudo ufw allow 22/tcp

# 允许 HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 禁止其他端口
sudo ufw default deny incoming

# 启用防火墙
sudo ufw enable
```

---

## 十、部署检查清单

- [ ] 服务器初始化完成
- [ ] Docker 和 Docker Compose 已安装
- [ ] MySQL 配置完成
- [ ] Redis 配置完成
- [ ] Nginx 配置完成
- [ ] SSL 证书已配置
- [ ] 环境变量已配置
- [ ] 数据库已创建
- [ ] 数据库迁移已执行
- [ ] 初始数据已导入
- [ ] 防火墙规则已配置
- [ ] 备份脚本已配置
- [ ] 监控告警已配置
- [ ] 域名已解析
- [ ] 微信支付商户号已配置
- [ ] 微信小程序已配置服务器域名

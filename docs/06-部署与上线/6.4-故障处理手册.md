# 6.4 故障处理手册

## 一、故障分类

### 1.1 故障级别

| 级别 | 定义 | 影响 | 响应时间 |
|------|------|------|---------|
| P0 - 致命 | 系统完全不可用 | 用户无法使用任何功能 | 5 分钟 |
| P1 - 严重 | 核心功能失效 | 影响主要业务流程 | 15 分钟 |
| P2 - 一般 | 次要功能异常 | 部分功能不可用 | 1 小时 |
| P3 - 轻微 | 性能下降/小问题 | 不影响主要功能 | 1 天 |

---

## 二、常见故障处理

### 2.1 系统宕机

**症状**: 服务无法访问

**排查步骤**:

```bash
# 1. 检查服务器状态
ping your-server-ip
ssh user@your-server-ip

# 2. 检查容器状态
docker ps -a

# 3. 检查 Docker 服务
sudo systemctl status docker

# 4. 检查系统资源
top
df -h
free -h

# 5. 查看系统日志
sudo journalctl -xe
```

**处理方法**:

```bash
# 重启 Docker 服务
sudo systemctl restart docker

# 重启所有服务
docker-compose -f docker-compose.prod.yml restart

# 重启特定服务
docker-compose -f docker-compose.prod.yml restart backend
```

**预防措施**:
- 配置自动重启策略
- 设置监控告警
- 定期检查系统日志

---

### 2.2 数据库连接失败

**症状**: 无法连接数据库，提示连接超时

**排查步骤**:

```bash
# 1. 检查 MySQL 容器状态
docker ps | grep mysql

# 2. 检查 MySQL 日志
docker logs mall_mysql_master

# 3. 检查 MySQL 服务
docker exec mall_mysql_master mysqladmin ping -h localhost

# 4. 检查连接数
docker exec mall_mysql_master mysql -u root -p -e "SHOW STATUS LIKE 'Threads_connected';"

# 5. 检查配置文件
docker exec mall_mysql_master cat /etc/my.cnf
```

**处理方法**:

```bash
# 重启 MySQL
docker-compose -f docker-compose.prod.yml restart mysql-master

# 清理空闲连接
docker exec mall_mysql_master mysql -u root -p -e "KILL <process_list_id>;"

# 优化连接池配置
# 修改 .env.prod 增加连接池大小
```

**预防措施**:
- 设置合理的连接池大小
- 监控连接数使用情况
- 定期清理空闲连接

---

### 2.3 Redis 连接失败

**症状**: 缓存失效，性能下降

**排查步骤**:

```bash
# 1. 检查 Redis 容器状态
docker ps | grep redis

# 2. 检查 Redis 日志
docker logs mall_redis_master

# 3. 测试连接
docker exec mall_redis_master redis-cli -a your_password ping

# 4. 检查内存使用
docker exec mall_redis_master redis-cli -a your_password INFO memory

# 5. 检查连接数
docker exec mall_redis_master redis-cli -a your_password INFO clients
```

**处理方法**:

```bash
# 重启 Redis
docker-compose -f docker-compose.prod.yml restart redis-master

# 清理过期键
docker exec mall_redis_master redis-cli -a your_password --scan --pattern "*:cache:*" | \
  xargs redis-cli -a your_password del

# 调整 maxmemory
# 修改 redis.conf 中的 maxmemory 配置
```

**预防措施**:
- 监控内存使用率
- 设置合适的驱逐策略
- 定期清理过期数据

---

### 2.4 API 响应缓慢

**症状**: 接口响应时间过长

**排查步骤**:

```bash
# 1. 检查后端日志
docker logs mall_backend_1 | tail -100

# 2. 检查慢查询
docker exec mall_mysql_master cat /var/log/mysql/mysql-slow.log | tail -50

# 3. 检查系统资源
top

# 4. 使用 curl 测试响应时间
curl -o /dev/null -s -w "%{time_total}\n" http://api.mall.com/api/v1/products

# 5. 查看数据库连接数
docker exec mall_mysql_master mysql -u root -p -e "SHOW PROCESSLIST;"
```

**处理方法**:

```bash
# 优化慢查询
# 1. 使用 EXPLAIN 分析查询
docker exec mall_mysql_master mysql -u root -p -e "EXPLAIN SELECT ..."

# 2. 添加索引
docker exec mall_mysql_master mysql -u root -p -e "ALTER TABLE orders ADD INDEX idx_user_created (user_id, created_at);"

# 3. 重启后端
docker-compose -f docker-compose.prod.yml restart backend

# 4. 清理缓存
docker exec mall_redis_master redis-cli -a your_password FLUSHDB
```

**预防措施**:
- 定期分析慢查询
- 添加合适的索引
- 使用缓存优化查询
- 启用数据库查询缓存

---

### 2.5 支付回调失败

**症状**: 用户支付成功但订单状态未更新

**排查步骤**:

```bash
# 1. 检查后端日志
docker logs mall_backend_1 | grep payment | tail -50

# 2. 检查微信支付日志
docker logs mall_backend_1 | grep wechatpay | tail -50

# 3. 查看订单状态
docker exec mall_mysql_master mysql -u root -p -e \
  "SELECT order_no, status, pay_time FROM orders WHERE order_no = 'your_order_no';"

# 4. 查询微信支付订单
# 使用微信支付商户平台工具查询
```

**处理方法**:

```python
# 1. 手动查询支付状态
# 使用 wechatpayv3 SDK 查询

# 2. 更新订单状态
docker exec mall_backend_1 python -c "
from app.db.session import SessionLocal
from app.models.order import Order

db = SessionLocal()
order = db.query(Order).filter_by(order_no='your_order_no').first()
if order:
    order.status = 1  # 待发货
    order.pay_time = datetime.now()
    db.commit()
db.close()
"

# 3. 手动扣减库存
# 根据订单商品手动扣减库存
```

**预防措施**:
- 添加支付重试机制
- 设置监控告警
- 定期对账

---

### 2.6 库存超卖

**症状**: 订单数量超过库存

**排查步骤**:

```bash
# 1. 检查库存锁
docker exec mall_redis_master redis-cli -a your_password KEYS "stock:lock:*"

# 2. 检查实际库存
docker exec mall_mysql_master mysql -u root -p -e \
  "SELECT id, name, stock FROM product_skus WHERE id IN (SELECT sku_id FROM order_items);"

# 3. 检查订单数
docker exec mall_mysql_master mysql -u root -p -e \
  "SELECT sku_id, SUM(quantity) as total FROM order_items GROUP BY sku_id;"
```

**处理方法**:

```bash
# 1. 停止接收订单
# 修改商品状态为下架

# 2. 手动调整库存
docker exec mall_mysql_master mysql -u root -p -e \
  "UPDATE product_skus SET stock = actual_stock WHERE id = <sku_id>;"

# 3. 处理超卖订单
# 联系用户协商退款或延期发货
```

**预防措施**:
- 使用 Redis 分布式锁
- 设置合理的锁定时间
- 添加库存检查逻辑
- 实现预扣库存机制

---

### 2.7 磁盘空间不足

**症状**: 写入失败，服务异常

**排查步骤**:

```bash
# 1. 检查磁盘空间
df -h

# 2. 查找大文件
du -sh /* | sort -rh | head -20

# 3. 检查日志文件
ls -lh /var/log/

# 4. 检查 Docker 卷
docker system df
```

**处理方法**:

```bash
# 1. 清理日志
docker system prune -a

# 2. 清理旧日志
sudo find /var/log -name "*.log" -mtime +7 -delete

# 3. 清理 Docker 镜像
docker image prune -a

# 4. 清理备份文件
find /data/backup -name "*.sql" -mtime +30 -delete
```

**预防措施**:
- 配置日志轮转
- 定期清理旧日志
- 设置磁盘监控告警
- 扩容磁盘空间

---

### 2.8 Nginx 502 错误

**症状**: 访问页面返回 502 Bad Gateway

**排查步骤**:

```bash
# 1. 检查 Nginx 状态
sudo systemctl status nginx

# 2. 检查 Nginx 日志
sudo tail -100 /var/log/nginx/error.log

# 3. 检查后端服务
docker ps | grep backend

# 4. 测试后端连接
curl http://localhost:8000/health

# 5. 检查 Nginx 配置
sudo nginx -t
```

**处理方法**:

```bash
# 1. 重启 Nginx
sudo systemctl restart nginx

# 2. 重启后端服务
docker-compose -f docker-compose.prod.yml restart backend

# 3. 检查 Nginx 配置
# 确保 upstream 配置正确
```

**预防措施**:
- 配置健康检查
- 设置自动重启策略
- 监控服务状态

---

### 2.9 小程序网络请求失败

**症状**: 小程序无法请求数据

**排查步骤**:

1. 检查网络请求配置
   - 检查 config.js 中的 API_BASE_URL
   - 检查是否使用 HTTPS

2. 检查服务器状态
   - 后端服务是否正常运行
   - Nginx 是否正常

3. 检查域名配置
   - 域名是否已备案
   - 服务器域名是否已配置

4. 查看小程序日志
   - 使用微信开发者工具查看 console
   - 查看 network 面板

**处理方法**:

```javascript
// 1. 确认 API 地址正确
const config = {
  API_BASE_URL: 'https://api.mall.com/api/v1'
}

// 2. 配置合法域名
// 在微信公众平台配置 request 合法域名

// 3. 开发环境关闭域名校验
// 微信开发者工具 -> 详情 -> 本地设置 -> 不校验合法域名
```

**预防措施**:
- 使用 HTTPS
- 配置合法域名
- 添加请求超时处理
- 添加错误重试机制

---

### 2.10 数据库死锁

**症状**: 事务执行超时

**排查步骤**:

```bash
# 1. 查看死锁日志
docker exec mall_mysql_master mysql -u root -p -e "SHOW ENGINE INNODB STATUS\G" | grep -A 10 "LATEST DETECTED DEADLOCK"

# 2. 查看当前事务
docker exec mall_mysql_master mysql -u root -p -e "SHOW PROCESSLIST;"

# 3. 查看锁等待
docker exec mall_mysql_master mysql -u root -p -e "SELECT * FROM information_schema.INNODB_LOCKS;"
```

**处理方法**:

```sql
-- 1. 杀死死锁进程
KILL <process_list_id>;

-- 2. 分析死锁原因
-- 使用 EXPLAIN 分析查询
-- 检查事务隔离级别
-- 优化 SQL 语句
```

**预防措施**:
- 尽量缩短事务时间
- 按相同顺序访问表
- 添加合适的索引
- 使用乐观锁

---

## 三、故障响应流程

### 3.1 发现故障

- 监控告警
- 用户反馈
- 日常巡检

---

### 3.2 故障评估

| 步骤 | 内容 |
|------|------|
| 1 | 确认故障级别 (P0/P1/P2/P3) |
| 2 | 评估影响范围和影响程度 |
| 3 | 通知相关人员 |
| 4 | 准备应急方案 |

---

### 3.3 故障定位

| 步骤 | 内容 |
|------|------|
| 1 | 查看监控数据 |
| 2 | 查看日志文件 |
| 3 | 复现故障现象 |
| 4 | 定位故障原因 |

---

### 3.4 故障修复

| 步骤 | 内容 |
|------|------|
| 1 | 实施应急方案 |
| 2 | 监控修复效果 |
| 3 | 验证故障恢复 |
| 4 | 恢复正常服务 |

---

### 3.5 复盘总结

| 步骤 | 内容 |
|------|------|
| 1 | 分析故障原因 |
| 2 | 总结经验教训 |
| 3 | 制定预防措施 |
| 4 | 更新文档和流程 |

---

## 四、应急联系

### 4.1 内部联系

| 角色 | 姓名 | 电话 | 邮箱 |
|------|------|------|------|
| 运维负责人 | 张三 | 13800138000 | ops@mall.com |
| 后端负责人 | 李四 | 13900139000 | backend@mall.com |
| 产品负责人 | 王五 | 13700137000 | product@mall.com |

---

### 4.2 外部联系

| 服务 | 联系方式 |
|------|---------|
| 云服务商 | 客服电话 |
| 微信支付 | 商户平台 / 客服 |
| 域名服务商 | 控制台 / 客服 |

---

## 五、备份与恢复

### 5.1 数据备份

```bash
# 备份数据库
/opt/scripts/backup_mysql.sh

# 备份配置文件
tar -czf config_backup_$(date +%Y%m%d).tar.gz /opt/mall-system/.env.prod /etc/nginx/

# 备份证书
tar -czf ssl_backup_$(date +%Y%m%d).tar.gz /etc/nginx/ssl/
```

---

### 5.2 数据恢复

```bash
# 恢复数据库
docker run --rm -v /data/backup:/backup -v mall_mysql_data:/var/lib/mysql \
  mysql:8.0 sh -c "mysql -u root -p${MYSQL_ROOT_PASSWORD} < /backup/mall_20240120_120000.sql"

# 恢复配置文件
tar -xzf config_backup_20240120.tar.gz -C /

# 恢复证书
tar -xzf ssl_backup_20240120.tar.gz -C /
```

---

## 六、预防措施

### 6.1 监控告警

- 配置全面的监控指标
- 设置合理的告警阈值
- 配置多种告警通知方式

---

### 6.2 定期巡检

| 检查项 | 频率 | 负责人 |
|--------|------|--------|
| 服务器资源 | 每日 | 运维 |
| 数据库性能 | 每日 | 运维 |
| 备份完整性 | 每周 | 运维 |
| 安全漏洞扫描 | 每月 | 运维 |

---

### 6.3 演练测试

- 故障演练 (每季度)
- 备份恢复测试 (每月)
- 性能压力测试 (每季度)

---

## 七、文档维护

- 每次故障处理后更新文档
- 定期检查文档有效性
- 根据实际情况调整流程

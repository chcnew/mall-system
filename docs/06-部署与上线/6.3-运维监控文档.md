# 6.3 运维监控文档

## 一、监控体系

### 1.1 监控层级

```
应用层 (Application)
    ├── 后端服务 (FastAPI)
    ├── 前端服务 (Vue3)
    └── 小程序 (微信)

中间件层 (Middleware)
    ├── Nginx (反向代理)
    └── Celery (异步任务)

数据层 (Data)
    ├── MySQL (数据库)
    └── Redis (缓存)

基础设施层 (Infrastructure)
    ├── Docker (容器)
    ├── 服务器资源
    └── 网络状态
```

---

## 二、监控指标

### 2.1 应用层监控

#### 后端服务 (FastAPI)

**基础指标**:
- 请求响应时间 (P50, P95, P99)
- 请求吞吐量 (QPS)
- 错误率 (4xx, 5xx)
- 接口可用性

**业务指标**:
- 订单创建成功率
- 支付成功率
- 库存扣减准确率
- 优惠券核销率

#### 小程序监控

**性能指标**:
- 首屏加载时间
- 页面切换时间
- 网络请求成功率
- 白屏率

**业务指标**:
- 日活用户 (DAU)
- 留存率
- 转化率
- 支付成功率

---

### 2.2 数据层监控

#### MySQL

**性能指标**:
- QPS / TPS
- 慢查询数量
- 连接数
- 锁等待时间
- 缓冲池命中率

**资源指标**:
- CPU 使用率
- 内存使用率
- 磁盘 I/O
- 网络流量

#### Redis

**性能指标**:
- QPS
- 内存使用率
- 缓存命中率
- 命令执行时间

**资源指标**:
- 内存使用率
- 网络流量
- 连接数

---

### 2.3 基础设施监控

#### 服务器

**资源指标**:
- CPU 使用率
- 内存使用率
- 磁盘使用率
- 磁盘 I/O
- 网络流量
- 负载平均值

#### Docker

**容器指标**:
- 容器状态
- 容器资源使用
- 镜像数量
- 卷数量

---

## 三、监控工具

### 3.1 Prometheus + Grafana

#### 安装 Prometheus

```yaml
# docker-compose.yml
prometheus:
  image: prom/prometheus:latest
  container_name: mall_prometheus
  ports:
    - "9090:9090"
  volumes:
    - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    - prometheus_data:/prometheus
  networks:
    - mall_network
  restart: always

grafana:
  image: grafana/grafana:latest
  container_name: mall_grafana
  ports:
    - "3000:3000"
  environment:
    - GF_SECURITY_ADMIN_PASSWORD=admin
  volumes:
    - grafana_data:/var/lib/grafana
  networks:
    - mall_network
  depends_on:
    - prometheus
  restart: always
```

#### Prometheus 配置

```yaml
# prometheus/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # FastAPI 应用
  - job_name: 'fastapi'
    static_configs:
      - targets: ['backend:8000']
    metrics_path: '/metrics'

  # MySQL Exporter
  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql-exporter:9104']

  # Redis Exporter
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']

  # Node Exporter
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
```

---

### 3.2 ELK 日志收集

#### 安装 ELK

```yaml
# docker-compose.yml
elasticsearch:
  image: elasticsearch:7.17.0
  container_name: mall_elasticsearch
  environment:
    - discovery.type=single-node
    - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
  ports:
    - "9200:9200"
  volumes:
    - elasticsearch_data:/usr/share/elasticsearch/data
  networks:
    - mall_network
  restart: always

logstash:
  image: logstash:7.17.0
  container_name: mall_logstash
  volumes:
    - ./logstash/pipeline:/usr/share/logstash/pipeline
    - ./logs:/app/logs
  ports:
    - "5044:5044"
  networks:
    - mall_network
  depends_on:
    - elasticsearch
  restart: always

kibana:
  image: kibana:7.17.0
  container_name: mall_kibana
  environment:
    - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
  ports:
    - "5601:5601"
  networks:
    - mall_network
  depends_on:
    - elasticsearch
  restart: always
```

---

### 3.3 告警配置

#### Prometheus Alertmanager

```yaml
# alertmanager.yml
global:
  resolve_timeout: 5m

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'web.hook'

receivers:
- name: 'web.hook'
  webhook_configs:
  - url: 'http://your-webhook-url/alert'

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'dev', 'instance']
```

#### 告警规则

```yaml
# alerts.yml
groups:
- name: alert.rules
  rules:
  # API 响应时间告警
  - alert: HighAPILatency
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High API latency"

  # API 错误率告警
  - alert: HighAPIErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "High API error rate"

  # CPU 使用率告警
  - alert: HighCPUUsage
    expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage"

  # 内存使用率告警
  - alert: HighMemoryUsage
    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 80
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage"

  # 磁盘使用率告警
  - alert: HighDiskUsage
    expr: (node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes * 100 > 85
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "High disk usage"

  # MySQL 连接数告警
  - alert: HighMySQLConnections
    expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections * 100 > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High MySQL connections"

  # Redis 内存使用率告警
  - alert: HighRedisMemoryUsage
    expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 90
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "High Redis memory usage"
```

---

## 四、监控仪表板

### 4.1 应用性能仪表板

**指标**:
- 请求响应时间趋势
- 请求吞吐量趋势
- 错误率趋势
- 接口 Top 10 (响应时间、QPS）

**查询示例**:
```promql
# API 响应时间
rate(http_request_duration_seconds_sum[5m]) / rate(http_request_duration_seconds_count[5m])

# API QPS
rate(http_requests_total[5m])

# API 错误率
rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100
```

---

### 4.2 数据库性能仪表板

**指标**:
- MySQL QPS/TPS
- 慢查询数量
- 连接数趋势
- 锁等待时间
- 缓冲池命中率

**查询示例**:
```promql
# MySQL QPS
rate(mysql_global_status_questions[5m])

# 慢查询数量
mysql_global_status_slow_queries

# 连接数
mysql_global_status_threads_connected

# 缓冲池命中率
mysql_global_status_innodb_buffer_pool_read_requests /
  (mysql_global_status_innodb_buffer_pool_read_requests + mysql_global_status_innodb_buffer_pool_reads) * 100
```

---

### 4.3 服务器资源仪表板

**指标**:
- CPU 使用率
- 内存使用率
- 磁盘使用率
- 网络 I/O
- 负载平均值

**查询示例**:
```promql
# CPU 使用率
100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# 内存使用率
(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100

# 磁盘使用率
(node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes * 100
```

---

## 五、告警规则

### 5.1 告警级别

| 级别 | 说明 | 响应时间 | 响应方式 |
|------|------|---------|---------|
| P0 - 致命 | 系统不可用 | 5 分钟 | 电话、短信 |
| P1 - 严重 | 核心功能失效 | 15 分钟 | 电话、短信 |
| P2 - 警告 | 性能下降 | 30 分钟 | 邮件、钉钉 |
| P3 - 提醒 | 预警 | 1 小时 | 邮件 |

---

### 5.2 告警处理流程

1. **告警触发** → 接收告警通知
2. **初步评估** → 判断告警级别和影响范围
3. **故障定位** → 查看日志、监控数据
4. **故障修复** → 采取修复措施
5. **验证恢复** → 确认问题已解决
6. **复盘总结** → 分析原因、制定预防措施

---

## 六、日志管理

### 6.1 日志分类

**应用日志**:
- 访问日志 (access.log)
- 错误日志 (error.log)
- 慢查询日志 (slow.log)

**系统日志**:
- Docker 日志
- Nginx 日志
- MySQL 慢查询日志
- Redis 日志

---

### 6.2 日志收集

```bash
# 查看后端日志
docker logs -f mall_backend_1

# 查看最近 100 行日志
docker logs --tail=100 mall_backend_1

# 查看 MySQL 慢查询
docker exec mall_mysql_master cat /var/log/mysql/mysql-slow.log

# 查看 Nginx 访问日志
sudo tail -f /var/log/nginx/access.log
```

---

### 6.3 日志分析

```bash
# 分析错误日志
docker logs mall_backend_1 2>&1 | grep ERROR | tail -20

# 统计错误数量
docker logs mall_backend_1 2>&1 | grep ERROR | wc -l

# 分析慢查询
docker exec mall_mysql_master cat /var/log/mysql/mysql-slow.log | \
  grep -A 5 "# Time:" | grep "# Query_time:" | awk '{print $3}' | sort -n | uniq -c

# 分析 Nginx 访问日志
sudo tail -1000 /var/log/nginx/access.log | \
  awk '{print $1}' | sort | uniq -c | sort -rn | head -10
```

---

## 七、性能优化建议

### 7.1 数据库优化

- 优化慢查询
- 添加合适索引
- 调整连接池大小
- 启用查询缓存

### 7.2 缓存优化

- 合理设置缓存过期时间
- 预热热点数据
- 使用 Redis 集群

### 7.3 应用优化

- 异步处理耗时操作
- 使用连接池
- 优化数据库查询
- 启用 Gzip 压缩

---

## 八、监控检查清单

- [ ] Prometheus 已配置
- [ ] Grafana 仪表板已创建
- [ ] ELK 日志收集已配置
- [ ] 告警规则已配置
- [ ] 告警通知已配置
- [ ] 日志轮转已配置
- [ ] 监控数据已保留
- [ ] 监控检查脚本已创建

---

## 九、应急响应

### 9.1 故障分类

| 故障类型 | 响应时间 | 处理方式 |
|---------|---------|---------|
| 系统宕机 | 5 分钟 | 重启服务、检查日志 |
| 数据库异常 | 10 分钟 | 重启数据库、检查连接 |
| 网络异常 | 15 分钟 | 检查网络配置、防火墙 |
| 支付异常 | 5 分钟 | 检查支付回调、手动对账 |

---

### 9.2 应急联系方式

| 角色 | 姓名 | 电话 | 邮箱 |
|------|------|------|------|
| 运维负责人 | 张三 | 13800138000 | ops@mall.com |
| 后端负责人 | 李四 | 13900139000 | backend@mall.com |
| 产品负责人 | 王五 | 13700137000 | product@mall.com |

---

## 十、持续改进

### 10.1 监控优化

- 定期检查告警规则有效性
- 优化仪表板可视化
- 添加新的监控指标
- 优化告警阈值

### 10.2 日志优化

- 优化日志格式
- 添加更多上下文信息
- 优化日志查询性能
- 添加日志分析工具

# 6.2 部署流程文档

## 一、部署前准备

### 1.1 代码检查

```bash
# 拉取最新代码
git pull origin main

# 检查分支
git branch

# 查看提交记录
git log --oneline -10
```

---

### 1.2 环境检查

```bash
# 检查 Docker 版本
docker --version

# 检查 Docker Compose 版本
docker-compose --version

# 检查磁盘空间
df -h

# 检查内存
free -h

# 检查 CPU
nproc
```

---

## 二、构建镜像

### 2.1 后端镜像

```bash
cd backend

# 构建镜像
docker build -t mall-backend:latest .

# 查看镜像
docker images | grep mall-backend

# 推送到镜像仓库（可选）
docker tag mall-backend:latest your-registry.com/mall-backend:latest
docker push your-registry.com/mall-backend:latest
```

---

### 2.2 前端镜像

```bash
cd admin

# 构建镜像
docker build -t mall-admin:latest .

# 查看镜像
docker images | grep mall-admin

# 推送到镜像仓库（可选）
docker tag mall-admin:latest your-registry.com/mall-admin:latest
docker push your-registry.com/mall-admin:latest
```

---

## 三、数据库迁移

### 3.1 备份数据库

```bash
# 备份数据库
docker exec mall_mysql_master mysqldump -u root -p${MYSQL_ROOT_PASSWORD} \
  mall_prod_db > backup_$(date +%Y%m%d_%H%M%S).sql

# 验证备份
ls -lh backup_*.sql
```

---

### 3.2 执行迁移

```bash
# 进入后端容器
docker exec -it mall_backend_1 bash

# 查看当前版本
alembic current

# 执行迁移
alembic upgrade head

# 验证迁移
alembic history | head -20
```

---

## 四、部署服务

### 4.1 停止旧服务

```bash
# 备份当前配置
cp .env.prod .env.prod.backup

# 停止所有服务
docker-compose -f docker-compose.prod.yml down

# 查看容器状态
docker-compose -f docker-compose.prod.yml ps
```

---

### 4.2 启动新服务

```bash
# 拉取最新镜像（如果使用镜像仓库）
docker pull your-registry.com/mall-backend:latest
docker pull your-registry.com/mall-admin:latest

# 启动所有服务
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f
```

---

### 4.3 健康检查

```bash
# 检查容器状态
docker-compose -f docker-compose.prod.yml ps

# 检查后端健康
curl -f http://localhost:8000/health || echo "Backend not healthy"

# 检查数据库连接
docker exec mall_mysql_master mysqladmin ping -h localhost -u root -p${MYSQL_ROOT_PASSWORD}

# 检查 Redis 连接
docker exec mall_redis_master redis-cli -a ${REDIS_PASSWORD} ping
```

---

## 五、初始化数据

### 5.1 导入初始数据

```bash
# 如果数据库为空，执行初始化
docker exec mall_backend_1 python scripts/init_data.py

# 验证数据
docker exec mall_mysql_master mysql -u root -p${MYSQL_ROOT_PASSWORD} -e \
  "USE mall_prod_db; SELECT COUNT(*) FROM admins;"
```

---

## 六、Nginx 配置

### 6.1 配置 SSL 证书

```bash
# 检查证书是否存在
ls -la /etc/nginx/ssl/

# 如果证书不存在，申请证书
sudo certbot --nginx -d api.mall.com -d admin.mall.com

# 验证证书
sudo certbot certificates
```

---

### 6.2 重启 Nginx

```bash
# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx

# 查看状态
sudo systemctl status nginx
```

---

## 七、验证部署

### 7.1 后端验证

```bash
# 检查 API 文档
curl http://api.mall.com/docs

# 测试登录接口
curl -X POST http://api.mall.com/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 检查数据库连接
docker exec mall_backend_1 python -c "from app.db.session import engine; engine.connect()"
```

---

### 7.2 前端验证

```bash
# 检查管理后台
curl -I https://admin.mall.com

# 访问管理后台
# 浏览器打开: https://admin.mall.com
```

---

### 7.3 小程序验证

```bash
# 在微信开发者工具中：
# 1. 修改 config.js 中的 API_BASE_URL
# 2. 配置服务器域名
# 3. 预览小程序
# 4. 测试登录、下单、支付流程
```

---

## 八、回滚方案

### 8.1 数据库回滚

```bash
# 停止服务
docker-compose -f docker-compose.prod.yml down

# 恢复数据库
docker run --rm -v /data/backup:/backup -v mall_mysql_data:/var/lib/mysql \
  mysql:8.0 sh -c "mysql -u root -p${MYSQL_ROOT_PASSWORD} < /backup/mall_20240120_120000.sql"

# 启动服务
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d
```

---

### 8.2 代码回滚

```bash
# 停止服务
docker-compose -f docker-compose.prod.yml down

# 回退代码
git checkout <previous_commit>

# 重新构建镜像
docker-compose -f docker-compose.prod.yml build

# 启动服务
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d
```

---

## 九、性能优化

### 9.1 数据库优化

```bash
# 进入 MySQL
docker exec -it mall_mysql_master mysql -u root -p

# 优化表
USE mall_prod_db;
OPTIMIZE TABLE orders;
OPTIMIZE TABLE order_items;
ANALYZE TABLE orders;

# 退出
EXIT;
```

---

### 9.2 Redis 优化

```bash
# 清理过期键
docker exec mall_redis_master redis-cli -a ${REDIS_PASSWORD} --scan --pattern "*:lock:*" | xargs redis-cli -a ${REDIS_PASSWORD} del
```

---

## 十、监控与日志

### 10.1 查看日志

```bash
# 查看所有服务日志
docker-compose -f docker-compose.prod.yml logs -f

# 查看特定服务日志
docker-compose -f docker-compose.prod.yml logs -f backend

# 查看最近 100 行日志
docker-compose -f docker-compose.prod.yml logs --tail=100 backend
```

---

### 10.2 监控脚本

```bash
# 创建监控脚本
cat > /opt/scripts/monitor.sh << 'EOF'
#!/bin/bash

echo "=== 容器状态 ==="
docker-compose -f /opt/mall-system/docker-compose.prod.yml ps

echo -e "\n=== 磁盘使用 ==="
df -h

echo -e "\n=== 内存使用 ==="
free -h

echo -e "\n=== CPU 使用 ==="
top -bn1 | head -20

echo -e "\n=== 后端响应时间 ==="
curl -o /dev/null -s -w "%{time_total}\n" http://api.mall.com/health

echo -e "\n=== 数据库连接数 ==="
docker exec mall_mysql_master mysql -u root -p${MYSQL_ROOT_PASSWORD} -e "SHOW STATUS LIKE 'Threads_connected';"
EOF

# 添加执行权限
chmod +x /opt/scripts/monitor.sh

# 定时监控（每 5 分钟）
(crontab -l 2>/dev/null; echo "*/5 * * * * /opt/scripts/monitor.sh >> /var/log/monitor.log 2>&1") | crontab -
```

---

## 十一、部署检查清单

- [ ] 代码已更新
- [ ] 环境变量已配置
- [ ] 镜像已构建
- [ ] 数据库已备份
- [ ] 数据库迁移已执行
- [ ] 初始数据已导入
- [ ] 服务已启动
- [ ] 健康检查通过
- [ ] Nginx 已重启
- [ ] SSL 证书有效
- [ ] 后端 API 可访问
- [ ] 前端页面可访问
- [ ] 小程序可正常使用
- [ ] 日志正常输出
- [ ] 监控已配置

---

## 十二、常见问题

### Q1: 容器启动失败

**排查步骤**:
1. 查看容器日志: `docker logs <container_name>`
2. 检查配置文件: `.env.prod`
3. 检查端口占用: `netstat -tuln | grep <port>`
4. 检查磁盘空间: `df -h`

---

### Q2: 数据库连接失败

**排查步骤**:
1. 检查 MySQL 是否启动: `docker exec mall_mysql_master mysqladmin ping`
2. 检查连接字符串: `.env.prod` 中的 `DATABASE_URL`
3. 检查用户权限: MySQL 中用户是否存在且有权限
4. 检查防火墙: 端口 3306 是否开放

---

### Q3: 支付回调失败

**排查步骤**:
1. 检查回调地址: 是否为 HTTPS 且公网可访问
2. 检查商户配置: 微信支付回调地址是否正确
3. 查看后端日志: 回调是否到达
4. 检查签名: 验签是否正确

---

### Q4: 性能下降

**排查步骤**:
1. 查看系统资源: `htop`
2. 查看慢查询: MySQL 慢查询日志
3. 查看连接数: `docker exec mall_mysql_master mysql -e "SHOW STATUS LIKE 'Threads_connected';"`
4. 检查缓存: Redis 命中率

---

## 十三、后续维护

### 13.1 日常维护

```bash
# 每周任务
# 1. 检查磁盘空间
df -h

# 2. 检查日志大小
du -sh /var/log/*

# 3. 查看容器状态
docker ps

# 4. 查看错误日志
docker-compose logs --tail=100 | grep ERROR
```

---

### 13.2 安全更新

```bash
# 每月任务
# 1. 更新系统
sudo apt update && sudo apt upgrade -y

# 2. 更新 Docker
curl -fsSL https://get.docker.com | sh

# 3. 更新 SSL 证书
sudo certbot renew
```

---

### 13.3 数据清理

```bash
# 清理 Docker 资源
docker system prune -a

# 清理日志
docker system prune --log-type=journal

# 清理备份文件（保留 30 天）
find /data/backup -name "*.sql" -mtime +30 -delete
```
